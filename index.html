<!DOCTYPE html>
<html lang="en">
<!-- The 'dark' class and theme are controlled by JS -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vinayaka Industries | Component Database</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    /* ==========================================================================
       VINAYAKA INDUSTRIES :: COMPONENT DATABASE STYLESHEET V5
       ========================================================================== */
    :root {
      --sidebar-width: 260px;
      --sidebar-width-collapsed: 80px;
      --header-height: 72px;
      --font-family-base: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      --font-weight-black: 800;

      --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem; --space-4: 1rem; --space-5: 1.25rem; --space-6: 1.5rem; --space-8: 2rem;

      --border-width: 1px;
      --radius-sm: 0.25rem; --radius-md: 0.5rem; --radius-lg: 0.75rem;

      --transition-speed-fast: 150ms; --transition-speed-normal: 300ms;
      --transition-curve-bounce: cubic-bezier(0.4, 0, 0.2, 1);
      --transition-curve-smooth: ease-in-out;

      /* THEMEABLE COLORS (HSL for easy changes) */
      --color-accent-h: 45;
      --color-accent-s: 100%;
      --color-accent-l: 52%;
      --color-accent-main: hsl(var(--color-accent-h), var(--color-accent-s), var(--color-accent-l));
      --color-accent-focus-ring: hsla(var(--color-accent-h), var(--color-accent-s), var(--color-accent-l), 25%);

      /* LIGHT THEME */
      --color-bg-primary: #F8F9FA;
      --color-bg-secondary: #FFFFFF;
      --color-bg-tertiary: #E9ECEF;
      --color-text-primary: #212529;
      --color-text-secondary: #6C757D;
      --color-text-on-accent: #212529;
      --color-text-on-danger: #FFFFFF;
      --color-border-primary: #DEE2E6;
      --color-border-focus: var(--color-accent-main);
      --color-status-danger: #DC3545;
      --color-status-warning: #FD7E14;
      --color-status-success: #198754;
      --shadow-color: 220 23% 10%;
      --shadow-elevation-low: 0.3px 0.5px 0.7px hsl(var(--shadow-color) / 0.11), 0.4px 0.8px 1px -1.2px hsl(var(--shadow-color) / 0.11), 1px 2px 2.5px -2.5px hsl(var(--shadow-color) / 0.11);
      --shadow-elevation-medium: 0.3px 0.5px 0.7px hsl(var(--shadow-color) / 0.1), 0.8px 1.6px 2px -0.8px hsl(var(--shadow-color) / 0.1), 2.1px 4.1px 5.2px -1.7px hsl(var(--shadow-color) / 0.1), 5px 10px 12.6px -2.5px hsl(var(--shadow-color) / 0.1);
    }
    html.dark {
      --color-bg-primary: #121212;
      --color-bg-secondary: #1E1E1E;
      --color-bg-tertiary: #2C2C2C;
      --color-text-primary: #EAEAEA;
      --color-text-secondary: #888888;
      --color-border-primary: #3A3A3A;
      --color-status-danger: #EF5350;
      --color-status-warning: #FFA726;
      --color-status-success: #4CAF50;
      --shadow-color: 220 23% 5%;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; scroll-behavior: smooth; }
    body {
      font-family: var(--font-family-base);
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
      line-height: 1.6;
      transition: background-color var(--transition-speed-normal) var(--transition-curve-smooth), color var(--transition-speed-normal) var(--transition-curve-smooth);
    }
    h1,h2,h3,h4,h5,h6 { font-weight: var(--font-weight-black); line-height: 1.2; }

    .fade-in { animation: fadeIn var(--transition-speed-normal) var(--transition-curve-smooth); }
    .scale-in { animation: scaleIn var(--transition-speed-normal) var(--transition-curve-bounce); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .main-content { padding-left: var(--sidebar-width); transition: padding-left var(--transition-speed-normal) var(--transition-curve-bounce); }
    .sidebar { background-color: var(--color-bg-secondary); border-right: var(--border-width) solid var(--color-border-primary); transition: width var(--transition-speed-normal) var(--transition-curve-bounce), transform var(--transition-speed-normal) var(--transition-curve-bounce); height: 100vh; }
    body.sidebar-collapsed .main-content { padding-left: var(--sidebar-width-collapsed); }
    body.sidebar-collapsed .sidebar { width: var(--sidebar-width-collapsed); }
    body.sidebar-collapsed .sidebar-nav-link span,
    body.sidebar-collapsed .sidebar-header-title,
    body.sidebar-collapsed .profile-info { display: none; }
    body.sidebar-collapsed .sidebar-header { justify-content: center; }
    body.sidebar-collapsed .sidebar-nav-link { justify-content: center; }
    body.sidebar-collapsed #sidebar-collapse-btn { right: -16px; }
    body.sidebar-collapsed #sidebar-collapse-btn i { transform: rotate(180deg); }
    
    .sidebar-nav-link { position: relative; transition: background-color var(--transition-speed-fast) var(--transition-curve-smooth), color var(--transition-speed-fast) var(--transition-curve-smooth); }
    .sidebar-nav-link::before { content: ''; position: absolute; left: 0; top: 50%; width: 4px; height: 60%; background-color: var(--color-accent-main); border-radius: 0 4px 4px 0; transform: translateY(-50%) scaleY(0); transition: transform var(--transition-speed-fast) var(--transition-curve-bounce); }
    .sidebar-nav-link:hover:not(.active) { background-color: var(--color-bg-tertiary); }
    .sidebar-nav-link:hover::before { transform: translateY(-50%) scaleY(1); }
    .sidebar-nav-link.active { background-color: var(--color-accent-main); color: var(--color-text-on-accent); font-weight: var(--font-weight-bold); }
    .sidebar-nav-link.active::before { transform: translateY(-50%) scaleY(1); }
    
    .industrial-card { position: relative; background-color: var(--color-bg-secondary); border: var(--border-width) solid var(--color-border-primary); border-radius: var(--radius-md); box-shadow: var(--shadow-elevation-low); transition: transform var(--transition-speed-fast) var(--transition-curve-bounce), box-shadow var(--transition-speed-fast) var(--transition-curve-bounce), border-color var(--transition-speed-fast) var(--transition-curve-smooth); }
    .industrial-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-elevation-medium); border-color: var(--color-accent-main); }
    .industrial-card th { position: -webkit-sticky; position: sticky; top: 0; background-color: var(--color-bg-secondary); z-index: 10; }
    .industrial-table tbody tr:nth-child(even) { background-color: var(--color-bg-tertiary); }
    .industrial-table tbody tr:hover { background-color: color-mix(in srgb, var(--color-accent-main) 15%, transparent); }

    .btn { display: inline-flex; align-items: center; justify-content: center; gap: var(--space-2); padding: var(--space-3) var(--space-5); border-radius: var(--radius-sm); font-weight: var(--font-weight-bold); text-align: center; border: var(--border-width) solid transparent; cursor: pointer; transition: transform var(--transition-speed-fast) var(--transition-curve-bounce), box-shadow var(--transition-speed-fast) var(--transition-curve-bounce), background-color var(--transition-speed-fast) var(--transition-curve-smooth), border-color var(--transition-speed-fast) var(--transition-curve-smooth); user-select: none; }
    .btn:focus-visible { outline: 2px solid var(--color-accent-main); outline-offset: 2px; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; border-bottom-width: 3px !important; }
    .btn--primary { background-color: var(--color-accent-main); color: var(--color-text-on-accent); border-bottom: 3px solid color-mix(in srgb, var(--color-text-primary) 25%, transparent); }
    .btn--primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow-elevation-low); }
    .btn--primary:active:not(:disabled) { transform: translateY(1px); border-bottom-width: 1px; }
    .btn--secondary { background-color: transparent; color: var(--color-text-primary); border-color: var(--color-border-primary); }
    .btn--secondary:hover:not(:disabled) { background-color: var(--color-bg-tertiary); border-color: var(--color-text-primary); }
    .btn--danger { background-color: transparent; color: var(--color-status-danger); border-color: var(--color-status-danger); }
    .btn--danger:hover:not(:disabled) { background-color: var(--color-status-danger); color: var(--color-text-on-danger); }
    
    .filter-control-group { background-color: var(--color-bg-tertiary); border: var(--border-width) solid var(--color-border-primary); border-radius: var(--radius-md); padding: var(--space-1) var(--space-3); transition: border-color var(--transition-speed-fast) var(--transition-curve-smooth), box-shadow var(--transition-speed-fast) var(--transition-curve-smooth); }
    .filter-control-group:focus-within { border-color: var(--color-border-focus); box-shadow: 0 0 0 3px var(--color-accent-focus-ring); }
    .filter-control-group label { font-size: 0.7rem; font-weight: var(--font-weight-semibold); color: var(--color-text-secondary); display: block; }
    .filter-control-input { background-color: transparent; border: none; outline: none; width: 100%; padding: 0.1rem 0; color: var(--color-text-primary); font-weight: var(--font-weight-medium); font-family: inherit; }
    .filter-control-input::placeholder { color: var(--color-text-secondary); opacity: 0.8; }
    
    .industrial-input { background-color: transparent; border: none; border-bottom: 2px solid var(--color-border-primary); border-radius: 0; padding: var(--space-3) var(--space-1); width: 100%; font-family: inherit; font-size: 1rem; transition: border-color var(--transition-speed-fast) var(--transition-curve-smooth); }
    .industrial-input:focus { outline: none; border-bottom-color: var(--color-border-focus); --tw-ring-color: transparent; }
    
    .blurred-value { filter: blur(8px); user-select: none; cursor: pointer; transition: filter var(--transition-speed-normal) var(--transition-curve-smooth); }
    .swal2-popup { font-family: var(--font-family-base); background-color: var(--color-bg-secondary) !important; color: var(--color-text-primary) !important; border: var(--border-width) solid var(--color-border-primary) !important; border-radius: var(--radius-lg) !important; }
    .swal2-title { color: var(--color-text-primary) !important; }
    .swal2-confirm { background-color: var(--color-accent-main) !important; color: var(--color-text-on-accent) !important; }
    .swal2-deny { background-color: var(--color-status-danger) !important; }
    .swal2-cancel { background-color: var(--color-bg-tertiary) !important; }
    
    @keyframes breathing { 0%,100%{ background-color: var(--color-bg-tertiary);} 50%{ background-color: color-mix(in srgb, var(--color-bg-tertiary) 80%, var(--color-bg-secondary)); } }
    .skeleton-breathe .skeleton-item { animation: breathing 2s var(--transition-curve-bounce) infinite; }
    .skeleton-breathe .skeleton-item:nth-child(2n){ animation-delay: 100ms; }
    .skeleton-breathe .skeleton-item:nth-child(3n){ animation-delay: 200ms; }
    
    .edit-mode-banner { background-color: color-mix(in srgb, var(--color-accent-main) 20%, transparent); border-bottom: 1px solid color-mix(in srgb, var(--color-accent-main) 40%, transparent); padding: 0.75rem 1.5rem; font-size: 0.9rem; font-weight: var(--font-weight-semibold); display: flex; align-items: center; gap: 0.5rem; color: var(--color-text-primary); }

    #command-palette { transition: opacity var(--transition-speed-fast) var(--transition-curve-smooth), transform var(--transition-speed-fast) var(--transition-curve-smooth); }
    #command-palette-results .result-item.selected { background-color: var(--color-accent-main); color: var(--color-text-on-accent); }
    #command-palette-results .result-item.selected .result-item-desc { color: var(--color-text-on-accent); opacity: 0.8; }
    
    #notification-center { transition: transform var(--transition-speed-normal) var(--transition-curve-bounce); transform: translateX(100%); }
    #notification-center.open { transform: translateX(0); }
    #notification-bell-btn::after { content: ''; position: absolute; top: 0.6rem; right: 0.6rem; width: 8px; height: 8px; border-radius: 99px; background-color: var(--color-status-danger); display: none; }
    #notification-bell-btn.has-unread::after { display: block; }
    
    #profile-dropdown, #settings-dropdown { transition: opacity var(--transition-speed-fast) var(--transition-curve-smooth), transform var(--transition-speed-fast) var(--transition-curve-smooth); }
    
    .image-gallery .gallery-image {
        transition: opacity var(--transition-speed-normal) var(--transition-curve-smooth);
    }

    @media (max-width: 1024px) {
      .main-content { padding-left: 0; }
      .sidebar { transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.2); z-index: 50; width: var(--sidebar-width) !important; }
      .sidebar.open { transform: translateX(0); }
      body.sidebar-collapsed .main-content { padding-left: 0; }
      .mobile-backdrop { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 49; transition: opacity var(--transition-speed-normal) var(--transition-curve-smooth); }
    }
    @media (max-width: 768px) {
      .industrial-table thead { display: none; }
      .industrial-table tr { display: block; border: none; border-bottom: 2px solid var(--color-border-primary); margin-bottom: 1rem; padding-bottom: 1rem; }
      .industrial-table tr:last-child { margin-bottom: 0; border-bottom: none; padding-bottom: 0; }
      .industrial-table tbody tr:nth-child(even) { background-color: transparent; }
      .industrial-table td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 0.75rem 0.25rem; border-bottom: 1px solid var(--color-bg-tertiary); }
      .industrial-table td:last-child { border-bottom: none; }
      .industrial-table td::before { content: attr(data-label); font-weight: var(--font-weight-bold); text-align: left; margin-right: 1rem; color: var(--color-text-secondary); }
    }
  </style>
</head>
<body class="antialiased">

  <!-- Login -->
  <div id="login-view" class="fixed inset-0 z-[100] flex flex-col items-center justify-center p-8 bg-[var(--color-bg-primary)]">
    <div class="text-center">
      <div class="inline-block bg-[var(--color-text-primary)] p-4 rounded-lg mb-6">
        <i data-lucide="gem" class="w-12 h-12 text-[var(--color-bg-primary)]"></i>
      </div>
      <h1 class="text-4xl font-black">Welcome to Vinayaka Industries DB</h1>
      <p class="text-lg text-[var(--color-text-secondary)] mt-2 mb-8">The Professional Component Inventory Platform.</p>
      <button id="signin-button-main" class="btn btn--primary text-lg">Sign In with Google</button>
    </div>
  </div>

  <!-- App wrapper -->
  <div id="app-wrapper" class="relative min-h-screen hidden">
    <div id="mobile-backdrop" class="mobile-backdrop hidden lg:hidden"></div>

    <!-- Sidebar -->
    <aside class="sidebar fixed top-0 left-0 w-[var(--sidebar-width)] flex flex-col">
      <div class="sidebar-header flex items-center gap-3 p-5 h-[var(--header-height)] border-b border-[var(--color-border-primary)] flex-shrink-0">
        <div class="bg-[var(--color-accent-main)] p-2.5 rounded-lg flex items-center justify-center">
          <i data-lucide="gem" class="w-6 h-6 text-[var(--color-text-on-accent)]"></i>
        </div>
        <h1 class="sidebar-header-title text-xl font-black">Vinayaka DB</h1>
      </div>

      <!-- Nav -->
      <nav class="flex-1 px-4 py-6 space-y-1">
        <a href="#" id="nav-dashboard" class="sidebar-nav-link active flex items-center gap-4 px-4 py-3 rounded-lg">
          <i data-lucide="layout-grid" class="w-5 h-5"></i><span class="truncate">Dashboard</span>
        </a>
        <a href="#" id="nav-activity" class="sidebar-nav-link flex items-center gap-4 px-4 py-3 text-[var(--color-text-secondary)] rounded-lg font-medium">
          <i data-lucide="history" class="w-5 h-5"></i><span class="truncate">Activity Log</span>
        </a>
      </nav>

      <!-- Sidebar Footer -->
      <div class="p-4 border-t border-[var(--color-border-primary)] flex-shrink-0 space-y-2">
        <div id="user-profile-area" class="relative">
          <div id="auth-signed-out-view" class="p-2 rounded-lg cursor-pointer group hover:bg-[var(--color-bg-tertiary)] transition-colors">
            <div class="flex items-center gap-3">
              <div class="w-11 h-11 rounded-full bg-[var(--color-bg-tertiary)] flex items-center justify-center border border-dashed border-[var(--color-border-primary)]"><i data-lucide="user-x" class="text-[var(--color-text-secondary)]"></i></div>
              <div class="profile-info"><p class="font-semibold text-[var(--color-text-secondary)]">Not Signed In</p><p class="text-xs text-[var(--color-text-secondary)] group-hover:text-[var(--color-accent-main)] transition-colors">Click to sign in</p></div>
            </div>
          </div>
          <div id="auth-signed-in-view" class="hidden">
            <button id="profile-btn" class="w-full p-2 rounded-lg hover:bg-[var(--color-bg-tertiary)] transition-colors">
              <div class="flex items-center gap-3">
                <img id="user-dp" class="w-11 h-11 rounded-full" src="" alt="User profile picture" onerror="this.onerror=null; this.src='https://placehold.co/44x44/E9ECEF/212529?text=U'">
                <div class="profile-info text-left"><p id="user-name" class="font-semibold truncate"></p><p class="text-xs text-[var(--color-status-success)] font-medium">Online</p></div>
              </div>
            </button>
            <div id="profile-dropdown" class="absolute bottom-full mb-2 w-full bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg shadow-lg p-2 origin-bottom scale-95 opacity-0 hidden">
                <div class="flex items-center justify-between p-2">
                    <label class="text-sm font-medium text-[var(--color-text-secondary)]">Theme</label>
                    <button id="theme-toggle" aria-label="Toggle light and dark theme" class="p-2 rounded-full hover:bg-[var(--color-bg-tertiary)] text-[var(--color-text-secondary)] transition-colors"><i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i><i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i></button>
                </div>
                <div id="theme-swatches" class="grid grid-cols-5 gap-2 p-2"></div>
                <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm rounded hover:bg-[var(--color-bg-tertiary)]">Help / Docs</a>
            </div>
          </div>
        </div>
        <button id="sign-out-btn" class="w-full btn btn--secondary !justify-start !text-[var(--color-status-danger)] !border-transparent hover:!bg-red-500/10">
            <i data-lucide="log-out" class="w-5 h-5"></i>
            <span class="truncate">Sign Out</span>
        </button>
      </div>
    </aside>

    <!-- Sidebar Collapse Button -->
    <button id="sidebar-collapse-btn" class="absolute top-1/2 -translate-y-1/2 right-0 z-20 w-8 h-8 flex items-center justify-center bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-full shadow-md transition-all duration-300 ease-in-out" style="right: -16px;">
        <i data-lucide="chevron-left" class="transition-transform duration-300"></i>
    </button>

    <!-- Main -->
    <main class="main-content flex-1 flex flex-col min-h-screen">
      <header class="sticky top-0 z-30 bg-[var(--color-bg-primary)]/80 backdrop-blur-sm h-[var(--header-height)] flex items-center justify-between px-6 lg:px-8 border-b border-[var(--color-border-primary)]">
        <div class="flex items-center gap-4">
          <button id="menuBtn" aria-label="Open sidebar menu" class="lg:hidden p-2 text-[var(--color-text-secondary)] -ml-2"><i data-lucide="menu" class="w-6 h-6"></i></button>
          <h2 class="text-2xl font-black" id="page-title">Dashboard</h2>
        </div>
        <div class="flex items-center gap-2 sm:gap-4">
          <button id="search-shortcut-btn" class="btn btn--secondary hidden sm:flex"><i data-lucide="search"></i><span class="hidden lg:inline">Search...</span><kbd class="hidden lg:inline ml-2 text-xs font-sans bg-white/10 border border-gray-400/20 rounded px-1.5 py-0.5">Ctrl K</kbd></button>
          <div id="layout-switcher" class="flex items-center gap-1 bg-[var(--color-bg-tertiary)] p-1 rounded-lg border border-[var(--color-border-primary)]">
            <button id="grid-view-btn" aria-label="Switch to grid view" class="p-2 rounded-md"><i data-lucide="layout-grid"></i></button>
            <button id="table-view-btn" aria-label="Switch to table view" class="p-2 rounded-md"><i data-lucide="table-2"></i></button>
          </div>
          <button id="add-item-header-btn" class="btn btn--primary"><i data-lucide="plus"></i><span class="hidden sm:inline">Add Item</span></button>
          <button id="compare-btn" class="btn btn--secondary hidden">Compare (0)</button>
          <button id="refresh-btn" class="p-2 rounded-full hover:bg-[var(--color-bg-tertiary)] text-[var(--color-text-secondary)] transition-colors" title="Refresh Data"><i data-lucide="refresh-cw" class="w-5 h-5"></i></button>
          <div class="relative">
              <button id="settings-btn" class="p-2 rounded-full hover:bg-[var(--color-bg-tertiary)] text-[var(--color-text-secondary)] transition-colors" title="Settings"><i data-lucide="settings"></i></button>
              <div id="settings-dropdown" class="absolute top-full mt-2 right-0 w-48 bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg shadow-lg p-2 origin-top-right scale-95 opacity-0 hidden">
                  <button id="manage-item-types-btn" class="w-full flex items-center gap-3 px-3 py-2 text-sm rounded hover:bg-[var(--color-bg-tertiary)]"><i data-lucide="list-plus" class="w-5 h-5"></i>Manage Item Types</button>
              </div>
          </div>
          <button id="notification-bell-btn" class="relative p-2 rounded-full hover:bg-[var(--color-bg-tertiary)] text-[var(--color-text-secondary)] transition-colors"><i data-lucide="bell"></i></button>
        </div>
      </header>

      <div id="app" class="flex-1 w-full p-6 lg:p-8">
        <!-- Dashboard View -->
        <div id="dashboard-view">
            <div class="mb-8">
                <h2 class="text-2xl font-black mb-4">Analytics Overview</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="industrial-card p-6 flex flex-col justify-between"><p class="text-sm font-semibold text-[var(--color-text-secondary)] opacity-80">Total Components</p><p id="total-components" class="text-3xl sm:text-4xl font-black mt-2">0</p></div>
                    <div class="industrial-card p-6 flex flex-col justify-between"><div class="flex justify-between items-start"><p class="text-sm font-semibold text-[var(--color-text-secondary)] opacity-80">Inventory Value</p><button id="value-toggle-btn" aria-label="Toggle inventory value visibility" class="text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]"><i data-lucide="eye-off" class="w-5 h-5"></i></button></div><p id="total-value" class="text-3xl sm:text-4xl font-black mt-2 break-all">₹0</p></div>
                    <div class="industrial-card p-6 flex flex-col justify-between"><p class="text-sm font-semibold text-[var(--color-text-secondary)] opacity-80">Low Stock Items</p><p id="low-stock" class="text-3xl sm:text-4xl font-black mt-2">0</p></div>
                    <div class="industrial-card p-6 flex flex-col justify-between"><p class="text-sm font-semibold text-[var(--color-text-secondary)] opacity-80">Out of Stock</p><p id="out-of-stock" class="text-3xl sm:text-4xl font-black mt-2 text-[var(--color-status-danger)]">0</p></div>
                </div>
            </div>
            <div class="bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg p-4 mb-8">
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="lg:col-span-1"><div class="filter-control-group flex items-center gap-2"><i data-lucide="search" class="w-5 h-5 text-[var(--color-text-secondary)] flex-shrink-0"></i><input type="text" id="search" placeholder="Search components..." class="filter-control-input"></div></div>
                        <div><div class="filter-control-group"><label for="filter-device">Device</label><select id="filter-device" class="filter-control-input"><option value="">All Devices</option></select></div></div>
                        <div><div class="filter-control-group"><label for="filter-size">Size</label><select id="filter-size" class="filter-control-input"><option value="">All Sizes</option></select></div></div>
                    </div>
                    <div class="flex-shrink-0"><div class="filter-control-group"><label for="sort-by">Sort By</label><select id="sort-by" class="filter-control-input"><option value="model-asc">Model (A-Z)</option><option value="price-desc">Price (High-Low)</option><option value="quantity-asc">Quantity (Low-High)</option></select></div></div>
                </div>
            </div>
            <div id="skeleton-loader" class="hidden"></div>
            <div id="searchResults" class="hidden"></div>
            <div id="no-results" class="hidden text-center py-16 industrial-card"><i data-lucide="search-x" class="w-16 h-16 mx-auto text-[var(--color-text-secondary)]"></i><h3 class="mt-4 text-2xl font-bold">No Components Found</h3><p class="mt-2 text-[var(--color-text-secondary)]">Your database is empty or your search returned no results.</p></div>
            <div id="pagination-controls" class="flex justify-center items-center gap-4 mt-8"></div>
        </div>
        
        <!-- Activity Log View -->
        <div id="activity-view" class="hidden">
            <div class="industrial-card overflow-hidden">
                <div id="activity-log-container" class="max-h-[75vh] overflow-y-auto">
                    <!-- Activity log content will be injected here by JS -->
                </div>
            </div>
        </div>
      </div>
    </main>
  </div>

  <!-- MODALS & OVERLAYS -->
  
  <!-- Add/Edit Form Modal -->
  <div id="formModal" role="dialog" aria-modal="true" aria-labelledby="form-title" class="fixed inset-0 z-50 justify-center items-start p-4 overflow-y-auto bg-black/70 hidden">
    <div class="bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg shadow-2xl w-full max-w-4xl my-8 flex flex-col scale-in">
      <div class="flex justify-between items-center p-6 border-b border-[var(--color-border-primary)]"><h2 id="form-title" class="text-2xl font-black">Add New Component</h2><button type="button" id="closeFormModalBtn" aria-label="Close form" class="text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button></div>
      <div id="edit-mode-banner" class="edit-mode-banner hidden"><i data-lucide="pencil" class="w-4 h-4"></i>You are currently editing an existing component.</div>
      <form id="partForm" class="p-6 space-y-6 overflow-y-auto">
        <input type="hidden" id="edit-id">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div><label for="model">Model*</label><input type="text" id="model" required class="mt-1 industrial-input"></div>
          <div><label for="device">Device</label><select id="device" class="mt-1 industrial-input"><option value="">(None)</option><option value="SWING DEVICE">Swing Device</option><option value="TRAVEL DEVICE">Travel Device</option></select></div>
          <div><label for="size">Size</label><select id="size" class="mt-1 industrial-input"><option value="">(None)</option><option value="SMALL">Small</option><option value="MIDDLE">Middle</option><option value="BIG">Big</option></select></div>
          <div><label for="item-name-main">Item Name*</label><select id="item-name-main" required class="mt-1 industrial-input"><option value="">Select item type...</option></select></div>
          <div><label for="price">Price</label><input type="number" id="price" placeholder="e.g., 4500" min="0" step="0.01" class="mt-1 industrial-input"></div>
          <div><label for="quantity">Quantity*</label><input type="number" id="quantity" required value="1" min="0" step="1" class="mt-1 industrial-input"></div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><label for="image-links-input">Image Links (comma-separated)</label><textarea id="image-links-input" placeholder="Paste one or more comma-separated Google Drive links..." class="industrial-input mt-1" rows="3"></textarea></div>
          <div><label for="note">Note</label><textarea id="note" rows="3" class="mt-1 industrial-input"></textarea></div>
        </div>
        <div id="spec-fields-container" class="hidden"><h3 class="text-lg font-bold border-b border-[var(--color-border-primary)] pb-2 mb-4">Specifications</h3><div id="spec-fields" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-4"></div></div>
      </form>
      <div class="p-6 border-t border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] flex justify-end gap-3"><button type="button" id="cancelBtn" class="btn btn--secondary">Cancel</button><button id="save-component-btn" type="submit" form="partForm" class="btn btn--primary">Save Component</button></div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detail-modal" role="dialog" aria-modal="true" aria-labelledby="detail-title" class="fixed inset-0 z-50 justify-center items-center p-4 hidden opacity-0 scale-95 transition-all duration-300">
    <div class="fixed inset-0 bg-black/70" id="detail-backdrop"></div>
    <div class="relative bg-[var(--color-bg-secondary)] w-full max-w-6xl max-h-[90vh] rounded-lg border border-[var(--color-border-primary)] flex flex-col"><div class="flex justify-between items-center p-4 border-b border-[var(--color-border-primary)] flex-shrink-0"><h2 id="detail-title" class="text-xl font-black">Component Datasheet</h2><button id="detail-close-btn" aria-label="Close details panel" class="p-2 text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] rounded-full hover:bg-[var(--color-bg-tertiary)]"><i data-lucide="x"></i></button></div><div id="detail-content" class="grid lg:grid-cols-3 gap-0 overflow-y-auto"></div></div>
  </div>

  <!-- Comparison Modal -->
  <div id="comparison-modal" role="dialog" aria-modal="true" aria-labelledby="comparison-title" class="fixed inset-0 z-50 justify-center items-start p-4 overflow-y-auto bg-black/70 hidden">
    <div class="bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg shadow-2xl w-full max-w-7xl my-8 flex flex-col scale-in"><div class="flex justify-between items-center p-6 border-b border-[var(--color-border-primary)]"><h2 id="comparison-title" class="text-2xl font-black">Compare Components</h2><button type="button" id="closeComparisonModalBtn" aria-label="Close comparison" class="text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button></div><div id="comparison-content" class="p-6 overflow-x-auto"></div></div>
  </div>

  <!-- Command Palette -->
  <div id="command-palette" role="dialog" aria-modal="true" class="fixed inset-0 z-[60] justify-center items-start p-4 bg-black/70 hidden opacity-0 -translate-y-4">
    <div class="bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg shadow-2xl w-full max-w-2xl mt-[10vh] flex flex-col">
      <div class="flex items-center gap-4 p-4 border-b border-[var(--color-border-primary)]">
        <i data-lucide="search" class="w-5 h-5 text-[var(--color-text-secondary)]"></i>
        <input type="text" id="command-palette-input" placeholder="Search components or run commands..." class="w-full bg-transparent outline-none text-lg">
      </div>
      <ul id="command-palette-results" class="p-2 max-h-[50vh] overflow-y-auto"></ul>
    </div>
  </div>

  <!-- Notification Center -->
  <div id="notification-center" class="fixed top-0 right-0 h-full w-full max-w-md bg-[var(--color-bg-secondary)] border-l border-[var(--color-border-primary)] z-[70] shadow-2xl flex flex-col">
      <div class="flex justify-between items-center p-4 border-b border-[var(--color-border-primary)]">
          <h2 class="text-xl font-black">Notifications</h2>
          <button id="notification-close-btn" class="p-2 text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] rounded-full hover:bg-[var(--color-bg-tertiary)]"><i data-lucide="x"></i></button>
      </div>
      <div id="notification-list" class="flex-1 p-4 overflow-y-auto space-y-3"></div>
  </div>
  
  <!-- Item Types Management Modal -->
  <div id="item-types-modal" role="dialog" aria-modal="true" aria-labelledby="item-types-title" class="fixed inset-0 z-50 justify-center items-start p-4 overflow-y-auto bg-black/70 hidden">
    <div class="bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg shadow-2xl w-full max-w-2xl my-8 flex flex-col scale-in">
      <div class="flex justify-between items-center p-6 border-b border-[var(--color-border-primary)]">
        <h2 id="item-types-title" class="text-2xl font-black">Manage Item Types</h2>
        <button type="button" id="close-item-types-modal-btn" aria-label="Close" class="text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <div id="item-types-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
        <button id="add-new-item-type-btn" class="btn btn--secondary w-full"><i data-lucide="plus"></i>Add New Item Type</button>
      </div>
      <div id="item-type-form-container" class="p-6 border-t border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] hidden">
        <form id="item-type-form" class="space-y-4">
          <input type="hidden" id="item-type-edit-name">
          <div>
            <label for="item-type-name" class="font-semibold">Item Name*</label>
            <input type="text" id="item-type-name" required class="mt-1 industrial-input">
          </div>
          <div>
            <label for="item-type-specs" class="font-semibold">Specifications</label>
            <textarea id="item-type-specs" class="mt-1 industrial-input" rows="3" placeholder="e.g., spec_height,spec_width,spec_material"></textarea>
            <p class="text-xs text-[var(--color-text-secondary)] mt-1">Enter a comma-separated list of specification names.</p>
          </div>
          <div class="flex justify-end gap-3 pt-2">
            <button type="button" id="cancel-item-type-btn" class="btn btn--secondary">Cancel</button>
            <button type="submit" class="btn btn--primary">Save Item Type</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://apis.google.com/js/api.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ================================================================================
      // 1. CONFIGURATION & STATE
      // ================================================================================
      const API_KEY = 'AIzaSyD3zRTlBC7t0-VJV49tdRF8SA3hrWN7pKw'; // WARNING: Exposing API keys on the client-side is a security risk.
      const CLIENT_ID = '1088294326380-399bo10d4vfiql44nu0mdd04hsanpdn2.apps.googleusercontent.com';
      const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4", "https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest"];
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile";
      const SPREADSHEET_ID = '1ezj8H6Wg_nQv6AKPE0VOU1YqSm-yIpgxKACAqhIwglQ';
      const SHEET_NAME = 'Sheet1';
      const AUDIT_SHEET_NAME = 'AuditLog';
      const ITEM_TYPES_SHEET_NAME = 'ItemTypes';
      let SHEET_ID = null;
      const INVENTORY_RANGE = `${SHEET_NAME}!A:ZZ`;
      const AUDIT_RANGE = `${AUDIT_SHEET_NAME}!A:E`;
      const ITEM_TYPES_RANGE = `${ITEM_TYPES_SHEET_NAME}!A:B`;

      let allItems = [], allActivity = [];
      let itemTypeDefinitions = new Map();
      let filteredItems = [];
      let gapiInited = false, gisInited = false;
      let tokenClient;
      let sheetHeaders = [];
      let currentUser = {};
      let currentLayout = 'grid';
      let currentPage = 1;
      const ITEMS_PER_PAGE = 12;
      let isValueVisible = false;
      let searchDebounceTimer;
      let comparisonList = new Set();
      let commandPaletteSelectedIndex = -1;
      
      const dom = {
        html: document.documentElement,
        body: document.body,
        appWrapper: document.getElementById('app-wrapper'),
        loginView: document.getElementById('login-view'),
        searchResults: document.getElementById('searchResults'),
        noResults: document.getElementById('no-results'),
        authSignedInView: document.getElementById('auth-signed-in-view'),
        authSignedOutView: document.getElementById('auth-signed-out-view'),
        signOutBtn: document.getElementById('sign-out-btn'),
        userDp: document.getElementById('user-dp'),
        userName: document.getElementById('user-name'),
        signInButtonMain: document.getElementById('signin-button-main'),
        partForm: document.getElementById('partForm'),
        formTitle: document.getElementById('form-title'),
        editId: document.getElementById('edit-id'),
        itemNameSelect: document.getElementById('item-name-main'),
        specFieldsContainer: document.getElementById('spec-fields-container'),
        specFields: document.getElementById('spec-fields'),
        search: document.getElementById('search'),
        formModal: document.getElementById('formModal'),
        closeFormModalBtn: document.getElementById('closeFormModalBtn'),
        cancelBtn: document.getElementById('cancelBtn'),
        imageLinksInput: document.getElementById('image-links-input'),
        skeletonLoader: document.getElementById('skeleton-loader'),
        menuBtn: document.getElementById('menuBtn'),
        sidebar: document.querySelector('.sidebar'),
        gridViewBtn: document.getElementById('grid-view-btn'),
        tableViewBtn: document.getElementById('table-view-btn'),
        themeToggle: document.getElementById('theme-toggle'),
        detailModal: document.getElementById('detail-modal'),
        detailBackdrop: document.getElementById('detail-backdrop'),
        detailContent: document.getElementById('detail-content'),
        detailCloseBtn: document.getElementById('detail-close-btn'),
        filterDevice: document.getElementById('filter-device'),
        filterSize: document.getElementById('filter-size'),
        sortBy: document.getElementById('sort-by'),
        paginationControls: document.getElementById('pagination-controls'),
        navDashboard: document.getElementById('nav-dashboard'),
        dashboardView: document.getElementById('dashboard-view'),
        layoutSwitcher: document.getElementById('layout-switcher'),
        pageTitle: document.getElementById('page-title'),
        valueToggleBtn: document.getElementById('value-toggle-btn'),
        totalValue: document.getElementById('total-value'),
        mobileBackdrop: document.getElementById('mobile-backdrop'),
        compareBtn: document.getElementById('compare-btn'),
        comparisonModal: document.getElementById('comparison-modal'),
        closeComparisonModalBtn: document.getElementById('closeComparisonModalBtn'),
        comparisonContent: document.getElementById('comparison-content'),
        editModeBanner: document.getElementById('edit-mode-banner'),
        saveBtn: document.getElementById('save-component-btn'),
        commandPalette: document.getElementById('command-palette'),
        commandPaletteInput: document.getElementById('command-palette-input'),
        commandPaletteResults: document.getElementById('command-palette-results'),
        searchShortcutBtn: document.getElementById('search-shortcut-btn'),
        notificationCenter: document.getElementById('notification-center'),
        notificationBellBtn: document.getElementById('notification-bell-btn'),
        notificationCloseBtn: document.getElementById('notification-close-btn'),
        notificationList: document.getElementById('notification-list'),
        profileBtn: document.getElementById('profile-btn'),
        profileDropdown: document.getElementById('profile-dropdown'),
        sidebarCollapseBtn: document.getElementById('sidebar-collapse-btn'),
        themeSwatches: document.getElementById('theme-swatches'),
        navActivity: document.getElementById('nav-activity'),
        activityView: document.getElementById('activity-view'),
        activityLogContainer: document.getElementById('activity-log-container'),
        addItemHeaderBtn: document.getElementById('add-item-header-btn'),
        refreshBtn: document.getElementById('refresh-btn'),
        settingsBtn: document.getElementById('settings-btn'),
        settingsDropdown: document.getElementById('settings-dropdown'),
        manageItemTypesBtn: document.getElementById('manage-item-types-btn'),
        itemTypesModal: document.getElementById('item-types-modal'),
        closeItemTypesModalBtn: document.getElementById('close-item-types-modal-btn'),
        itemTypesList: document.getElementById('item-types-list'),
        addNewItemTypeBtn: document.getElementById('add-new-item-type-btn'),
        itemTypeFormContainer: document.getElementById('item-type-form-container'),
        itemTypeForm: document.getElementById('item-type-form'),
        cancelItemTypeBtn: document.getElementById('cancel-item-type-btn'),
      };
      
      // ================================================================================
      // 2. AUTHENTICATION & API
      // ================================================================================
      async function initializeGapiClient() { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); gapiInited = true; maybeEnableButtons(); }
      
      function initializeGis() { 
        tokenClient = google.accounts.oauth2.initTokenClient({ 
            client_id: CLIENT_ID, 
            scope: SCOPES, 
            callback: (resp) => {
                if (resp.error) {
                    console.error("Authentication failed:", resp.error);
                    if (document.body.dataset.manualSignIn === 'true') {
                        Swal.fire({ title: 'Authentication Error', text: 'Could not sign in. Please try again.', icon: 'error' });
                        document.body.removeAttribute('data-manual-sign-in');
                    }
                    return;
                }
                gapi.client.setToken(resp); 
                updateAuthStatus(true); 
            }
        }); 
        gisInited = true; 
        maybeEnableButtons(); 
      }
      
      function maybeEnableButtons() { if (gapiInited && gisInited) { dom.signInButtonMain.onclick = handleAuthClick; dom.signOutBtn.onclick = handleAuthClick; lucide.createIcons(); } }
      
      function handleAuthClick() {
        if (!gapiInited || !gisInited) {
            Swal.fire('Loading...', 'Authentication libraries are still loading. Please try again in a moment.', 'info');
            return;
        }
        if (gapi.client.getToken() === null) {
            document.body.dataset.manualSignIn = 'true';
            tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
            Swal.fire({ title: 'Sign Out', text: 'Are you sure you want to sign out?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, sign out'}).then((result) => { if (result.isConfirmed) { gapi.client.setToken(null); updateAuthStatus(false); } });
        }
      }

      async function getSheetIdByName(title) { const meta = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: SPREADSHEET_ID, fields: "sheets.properties(sheetId,title)" }); const sheet = meta.result.sheets.find(s => s.properties.title === title); return sheet ? sheet.properties.sheetId : null; }
      
      async function updateAuthStatus(isSignedIn) {
        if (isSignedIn) {
          dom.loginView.classList.add('hidden');
          dom.appWrapper.classList.remove('hidden');
          dom.authSignedInView.classList.remove('hidden');
          dom.authSignedOutView.classList.add('hidden');
          try {
            const userInfo = await gapi.client.oauth2.userinfo.get();
            dom.userName.textContent = userInfo.result.name || "User";
            dom.userDp.src = userInfo.result.picture || `https://ui-avatars.com/api/?name=U&background=E9ECEF&color=212529`;
            currentUser = { name: userInfo.result.name, email: userInfo.result.email };
          } catch (e) {
            dom.userName.textContent = "User";
            dom.userDp.src = `https://ui-avatars.com/api/?name=U&background=E9ECEF&color=212529`;
            currentUser = { name: 'User', email: 'Unknown' };
          }
          try { SHEET_ID = await getSheetIdByName(SHEET_NAME); } catch {}
          loadAllData();
        } else {
          dom.loginView.classList.remove('hidden');
          dom.appWrapper.classList.add('hidden');
          dom.authSignedInView.classList.add('hidden');
          dom.authSignedOutView.classList.remove('hidden');
          allItems = []; sheetHeaders = []; currentUser = {}; allActivity = [];
          localStorage.removeItem('inventoryData');
          processAndRenderItems();
        }
      }
      async function loadAllData(isManualRefresh = false) {
        showSkeletonLoader(true);
        let success = false;
        try {
          const invRes = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: INVENTORY_RANGE });
          const inventoryValues = invRes.result.values;
          if (!inventoryValues || inventoryValues.length === 0) { 
            Swal.fire('Sheet Error', 'The main inventory sheet (Sheet1) is empty or could not be read.', 'error'); 
            showSkeletonLoader(false); 
            dom.noResults.classList.remove('hidden'); 
            return; 
          }
          sheetHeaders = inventoryValues[0];
          allItems = inventoryValues.slice(1).map((row, index) => { 
            const item = sheetHeaders.reduce((obj, header, i) => { obj[header] = row[i]; return obj; }, {}); 
            item.rowIndex = index + 2; 
            return item; 
          }).filter(item => item.id && item.id.trim() !== '');

          try {
            const auditRes = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: AUDIT_RANGE });
            const auditValues = auditRes.result.values;
            allActivity = (auditValues && auditValues.length > 1) ? auditValues.slice(1).map(row => ({ timestamp: row[0], user: row[1], action: row[2], itemId: row[3], details: row[4] })).reverse() : [];
          } catch (err) {
            console.error("Could not load AuditLog, but continuing...", err);
            allActivity = [];
          }

          try {
            const itemTypesRes = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: ITEM_TYPES_RANGE });
            const itemTypesValues = itemTypesRes.result.values;
            if (itemTypesValues && itemTypesValues.length > 1) {
              itemTypeDefinitions.clear();
              itemTypesValues.slice(1).forEach(row => {
                const itemName = row[0];
                const specs = row[1] ? row[1].split(',').map(s => s.trim()) : [];
                if (itemName) {
                  itemTypeDefinitions.set(itemName, specs);
                }
              });
            }
          } catch(err) {
            console.error("Could not load ItemTypes sheet, but continuing...", err);
            Swal.fire('Configuration Warning', 'Could not load the "ItemTypes" sheet. The "Add Item" form may not work correctly.', 'warning');
          }
          
          localStorage.setItem('inventoryData', JSON.stringify({ items: allItems, headers: sheetHeaders, activity: allActivity, timestamp: Date.now() }));
          success = true;
        
        } catch (err) { 
          handleApiError(err, 'Critical Data Loading Error'); 
          updateAuthStatus(false);
        } finally { 
          showSkeletonLoader(false); 
          populateFilters(); 
          processAndRenderItems(); 
          renderNotifications(); 
          renderActivityLog();
          if (isManualRefresh && success) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Data refreshed!',
                showConfirmButton: false,
                timer: 1500
            });
          }
        }
      }

      // ================================================================================
      // 3. ADD / UPDATE / DELETE & AUDIT LOG
      // ================================================================================
      async function logAction(action, itemId, details) {
        if (!gapi.client.getToken()) return;
        const timestamp = new Date().toISOString();
        const user = currentUser.name || 'Unknown User';
        const detailsString = JSON.stringify(details);
        const newRow = [timestamp, user, action, itemId, detailsString];
        try {
          await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: AUDIT_SHEET_NAME, valueInputOption: 'USER_ENTERED', resource: { values: [newRow] } });
        } catch (err) { console.error("Failed to write to audit log:", err); }
      }
      async function handleFormSubmit(e) {
        e.preventDefault();
        const submitButton = dom.saveBtn;
        const originalButtonHTML = submitButton.innerHTML;
        submitButton.innerHTML = `<svg class="animate-spin h-5 w-5 text-black inline-block align-middle" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...`;
        submitButton.disabled = true;
        try {
          const formData = collectFormData();
          if (!formData.model || !formData.itemName || !formData.quantity) { Swal.fire('Validation Error', 'Please fill out all required fields (*).', 'warning'); return; }
          if (parseFloat(formData.price) < 0 || parseInt(formData.quantity, 10) < 0) { Swal.fire('Invalid Input', 'Price and Quantity cannot be negative.', 'warning'); return; }
          if (isDuplicate()) { Swal.fire('Duplicate Component', 'An item with the same model, device, size, and name already exists.', 'warning'); return; }
          const editId = dom.editId.value;
          if (editId) { await updateComponent(editId, formData); } else { await addComponent(formData); }
        } catch (err) { handleApiError(err, dom.editId.value ? 'Update Error' : 'Save Error');
        } finally { submitButton.innerHTML = originalButtonHTML; submitButton.disabled = false; }
      }
      async function addComponent(newItemData) {
        newItemData.id = String(Date.now());
        const newRow = sheetHeaders.map(header => newItemData[header] || "");
        await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: SHEET_NAME, valueInputOption: 'USER_ENTERED', resource: { values: [newRow] } });
        Swal.fire({ title: 'Success!', text: 'Component added successfully.', icon: 'success', timer: 1800, showConfirmButton: false });
        await logAction('CREATE', newItemData.id, newItemData);
        closeFormModal(); localStorage.removeItem('inventoryData'); await loadAllData();
      }
      async function updateComponent(id, updatedItemData) {
        const itemToUpdate = allItems.find(item => item.id === id);
        if (!itemToUpdate) { throw new Error('Could not find the component to update.'); }
        updatedItemData.id = id;
        const updatedRow = sheetHeaders.map(header => updatedItemData[header] || "");
        const endColumn = columnToLetter(sheetHeaders.length);
        const updateRange = `${SHEET_NAME}!A${itemToUpdate.rowIndex}:${endColumn}${itemToUpdate.rowIndex}`;
        await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: updateRange, valueInputOption: 'USER_ENTERED', resource: { values: [updatedRow] } });
        Swal.fire({ title: 'Success!', text: 'Component updated successfully.', icon: 'success', timer: 1800, showConfirmButton: false });
        const changes = {};
        Object.keys(updatedItemData).forEach(key => { if (itemToUpdate[key] !== updatedItemData[key]) { changes[key] = { from: itemToUpdate[key] || '', to: updatedItemData[key] }; } });
        await logAction('UPDATE', id, changes);
        closeFormModal(); localStorage.removeItem('inventoryData'); await loadAllData();
      }
      async function deleteComponent(id) {
        const itemToDelete = allItems.find(item => item.id === id);
        if (!itemToDelete) { Swal.fire('Error', 'Could not find the component to delete.', 'error'); return; }
        if (SHEET_ID == null) { try { SHEET_ID = await getSheetIdByName(SHEET_NAME); } catch {} }
        if (SHEET_ID == null) { Swal.fire('Delete Error', 'Could not resolve sheetId for deletion.', 'error'); return; }
        try {
          await gapi.client.sheets.spreadsheets.batchUpdate({ spreadsheetId: SPREADSHEET_ID, resource: { requests: [{ deleteDimension: { range: { sheetId: SHEET_ID, dimension: 'ROWS', startIndex: itemToDelete.rowIndex - 1, endIndex: itemToDelete.rowIndex } } }] } });
          Swal.fire('Deleted!', 'The component has been deleted.', 'success');
          await logAction('DELETE', id, itemToDelete);
          closeDetailPanel(); localStorage.removeItem('inventoryData'); await loadAllData();
        } catch (err) { handleApiError(err, 'Delete Error'); }
      }

      // ================================================================================
      // 4. UI RENDERING & LOGIC
      // ================================================================================
      function processAndRenderItems() {
        if (!gapiInited) return;
        const searchTerm = dom.search.value.toLowerCase();
        const deviceFilter = dom.filterDevice.value;
        const sizeFilter = dom.filterSize.value;
        const sortBy = dom.sortBy.value;
        filteredItems = allItems.filter(item => { const searchMatch = Object.values(item).join(' ').toLowerCase().includes(searchTerm); const deviceMatch = !deviceFilter || item.device === deviceFilter; const sizeMatch = !sizeFilter || item.size === sizeFilter; return searchMatch && deviceMatch && sizeMatch; });
        switch (sortBy) { case 'price-desc': filteredItems.sort((a, b) => (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0)); break; case 'quantity-asc': filteredItems.sort((a, b) => (parseInt(a.quantity) || 0) - (parseInt(b.quantity) || 0)); break; default: filteredItems.sort((a, b) => (a.model || '').localeCompare(b.model || '')); break; }
        updateAnalytics(allItems); renderItems();
      }
      function renderItems() {
        if (!gapiInited || !gapi.client || (typeof gapi.client.getToken !== 'function')) return;
        dom.searchResults.innerHTML = '';
        dom.noResults.classList.toggle('hidden', filteredItems.length > 0 || !gapi.client.getToken());
        dom.searchResults.classList.toggle('hidden', filteredItems.length === 0);
        const paginatedItems = filteredItems.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);
        if (paginatedItems.length === 0 && currentPage > 1) { currentPage = 1; renderItems(); return; }
        const fragment = document.createDocumentFragment();
        switch (currentLayout) {
          case 'grid': dom.searchResults.className = 'grid gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5'; paginatedItems.forEach(item => fragment.appendChild(createGridCard(item))); break;
          case 'table': dom.searchResults.className = 'w-full overflow-x-auto industrial-card'; fragment.appendChild(createTableView(paginatedItems)); break;
        }
        dom.searchResults.appendChild(fragment); 
        lucide.createIcons(); 
        initGalleries(); 
        renderPaginationControls();
      }
      function createGridCard(item) {
        const card = document.createElement('div'); card.className = 'industrial-card overflow-hidden flex flex-col group';
        const images = (item.imageLinks || '').split(',').map(link => link.trim()).filter(Boolean);
        const firstImage = getDriveThumbnail(images[0]) || `https://placehold.co/512x512/E9ECEF/212529?text=${encodeURIComponent(item.itemName || 'N/A')}`;
        const quantity = parseInt(item.quantity) || 0;
        const statusColor = quantity === 0 ? 'bg-[var(--color-status-danger)]' : quantity < 5 ? 'bg-[var(--color-status-warning)]' : 'bg-[var(--color-status-success)]';
        const statusText = quantity > 0 ? `${quantity} in Stock` : 'Out of Stock';
        const isChecked = comparisonList.has(item.id);
        card.innerHTML = `<div class="relative image-gallery bg-[var(--color-bg-tertiary)]" data-images="${images.join(',')}"><img loading="lazy" src="${firstImage}" alt="${item.itemName}" class="gallery-image w-full h-52 object-contain" onerror="this.src='https://placehold.co/512x512/F8D7DA/721C24?text=Error';">${images.length > 1 ? `<button aria-label="Previous image" class="gallery-arrow absolute left-2 top-1/2 -translate-y-1/2 p-1 bg-black/50 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity" data-direction="-1"><i data-lucide="chevron-left"></i></button><button aria-label="Next image" class="gallery-arrow absolute right-2 top-1/2 -translate-y-1/2 p-1 bg-black/50 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity" data-direction="1"><i data-lucide="chevron-right"></i></button>` : ''}<div class="absolute top-2 left-2 flex items-center gap-2 text-xs font-bold px-2 py-1 rounded text-white ${statusColor}">${statusText}</div><input type="checkbox" data-id="${item.id}" class="compare-checkbox absolute top-2 right-2 h-5 w-5" ${isChecked ? 'checked' : ''}></div><div class="p-4 flex-grow flex flex-col"><h3 class="font-bold leading-tight capitalize">${[item.model, item.device, item.size, item.itemName].filter(Boolean).join(' ').toLowerCase()}</h3><p class="text-sm text-[var(--color-text-secondary)] mt-1">Price: <span class="font-semibold text-[var(--color-text-primary)]">₹${item.price || 'N/A'}</span></p><div class="mt-auto pt-4 text-right"><button class="view-details-btn text-sm font-bold text-[var(--color-accent-main)] hover:underline" data-id="${item.id}">View Details &rarr;</button></div></div>`;
        return card;
      }
      function createTableView(items) {
        const table = document.createElement('table'); table.className = 'w-full text-left border-collapse industrial-table';
        const headers = [{ key: 'compare', label: ''}, { key: 'component', label: 'Component'}, { key: 'price', label: 'Price'}, { key: 'quantity', label: 'Quantity'}, { key: 'actions', label: 'Actions'}];
        let head = `<thead><tr class="border-b border-[var(--color-border-primary)]">`; headers.forEach(h => { head += `<th class="p-4 font-semibold">${h.label}</th>`; }); head += `</tr></thead>`;
        let body = '<tbody>';
        items.forEach(item => { const quantity = parseInt(item.quantity) || 0; const statusColor = quantity === 0 ? 'text-[var(--color-status-danger)]' : quantity < 5 ? 'text-[var(--color-status-warning)]' : 'text-[var(--color-status-success)]'; const isChecked = comparisonList.has(item.id); body += `<tr class="border-b border-[var(--color-border-primary)] last:border-b-0"><td data-label="${headers[0].label}" class="p-4"><input type="checkbox" data-id="${item.id}" class="compare-checkbox h-5 w-5" ${isChecked ? 'checked' : ''}></td><td data-label="${headers[1].label}" class="p-4 capitalize font-medium">${[item.model, item.device, item.size, item.itemName].filter(Boolean).join(' ').toLowerCase()}</td><td data-label="${headers[2].label}" class="p-4 text-[var(--color-text-secondary)]">₹${item.price || 'N/A'}</td><td data-label="${headers[3].label}" class="p-4 font-medium ${statusColor}">${quantity}</td><td data-label="${headers[4].label}" class="p-4"><button class="view-details-btn text-sm font-bold text-[var(--color-accent-main)] hover:underline" data-id="${item.id}">Details</button></td></tr>`; });
        body += '</tbody>'; table.innerHTML = head + body; return table;
      }
      function switchLayout(layout) {
        currentLayout = layout; localStorage.setItem('layout', layout);
        ['gridViewBtn', 'tableViewBtn'].forEach(btnId => { dom[btnId].classList.remove('bg-[var(--color-bg-secondary)]', 'text-[var(--color-accent-main)]'); });
        dom[layout + 'ViewBtn'].classList.add('bg-[var(--color-bg-secondary)]', 'text-[var(--color-accent-main)]');
        processAndRenderItems();
      }
      function showSkeletonLoader(show) {
        dom.skeletonLoader.classList.toggle('hidden', !show); dom.searchResults.classList.add('hidden'); dom.noResults.classList.add('hidden');
        if (show) { let skeletonHtml = ''; for (let i = 0; i < 12; i++) { skeletonHtml += `<div class="industrial-card p-4 space-y-4"><div class="skeleton-item h-48 rounded"></div><div class="space-y-2"><div class="skeleton-item h-6 w-3/4 rounded"></div><div class="skeleton-item h-4 w-1/2 rounded"></div></div></div>`; } dom.skeletonLoader.innerHTML = `<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 skeleton-breathe">${skeletonHtml}</div>`; }
      }
      function initThemeAndLayout() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) { dom.html.classList.add('dark'); } else { dom.html.classList.remove('dark'); }
        const savedAccent = localStorage.getItem('accentColor');
        if (savedAccent) { applyTheme(JSON.parse(savedAccent)); }
        populateThemeSwatches();
        switchLayout(localStorage.getItem('layout') || 'grid');
        if (localStorage.getItem('sidebarCollapsed') === 'true') { dom.body.classList.add('sidebar-collapsed'); }
        updateValueVisibility();
      }
      function toggleTheme() { dom.html.classList.toggle('dark'); localStorage.setItem('theme', dom.html.classList.contains('dark') ? 'dark' : 'light'); }
      function getDriveThumbnail(url) { if (!url) return null; const match = url.match(/file\/d\/([a-zA-Z0-9_-]+)/); return match ? `https://drive.google.com/thumbnail?id=${match[1]}&sz=w512-h512` : url; }
      function initGalleries() {
        document.querySelectorAll('.image-gallery').forEach(gallery => {
            const images = (gallery.dataset.images || '').split(',').map(link => link.trim()).filter(Boolean);
            if (images.length <= 1) return;

            let currentIndex = 0;
            const imgElement = gallery.querySelector('.gallery-image');
            
            const preloadNext = () => {
                if (images.length > 1) {
                    const nextIndex = (currentIndex + 1) % images.length;
                    const img = new Image();
                    img.src = getDriveThumbnail(images[nextIndex]);
                }
            };

            imgElement.onload = preloadNext; 
            preloadNext();

            gallery.querySelectorAll('.gallery-arrow').forEach(arrow => {
                arrow.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const direction = parseInt(e.currentTarget.dataset.direction);
                    currentIndex = (currentIndex + direction + images.length) % images.length;
                    
                    imgElement.style.opacity = 0;
                    setTimeout(() => {
                        imgElement.src = getDriveThumbnail(images[currentIndex]);
                        imgElement.style.opacity = 1;
                    }, 300);
                });
            });
        });
      }


      // ================================================================================
      // 5. MODALS & FORMS
      // ================================================================================
      function openAddModal() { 
        dom.formTitle.textContent = 'Add New Component'; 
        dom.editId.value = ''; 
        dom.partForm.reset(); 
        populateItemNameDropdown();
        dom.specFieldsContainer.classList.add('hidden'); 
        dom.specFields.innerHTML = ''; 
        dom.editModeBanner.classList.add('hidden'); 
        dom.formModal.classList.remove('hidden'); 
        dom.formModal.classList.add('flex'); 
        trapFocus(dom.formModal); 
      }
      function openEditModal(item) { 
        dom.formTitle.textContent = 'Edit Component'; 
        dom.editId.value = item.id; 
        dom.partForm.querySelector('#model').value = item.model || ''; 
        dom.partForm.querySelector('#device').value = item.device || ''; 
        dom.partForm.querySelector('#size').value = item.size || ''; 
        populateItemNameDropdown();
        dom.itemNameSelect.value = item.itemName || ''; 
        dom.partForm.querySelector('#price').value = item.price || ''; 
        dom.partForm.querySelector('#quantity').value = item.quantity || '0'; 
        dom.imageLinksInput.value = item.imageLinks || ''; 
        dom.partForm.querySelector('#note').value = item.note || ''; 
        updateSpecFields(); 
        Object.keys(item).forEach(key => { if (key.startsWith('spec_')) { const input = dom.partForm.querySelector(`[name="${key}"]`); if (input) input.value = item[key]; } }); 
        dom.editModeBanner.classList.remove('hidden'); 
        dom.formModal.classList.remove('hidden'); 
        dom.formModal.classList.add('flex'); 
        trapFocus(dom.formModal); 
      }
      function closeFormModal() { dom.formModal.classList.add('hidden'); dom.formModal.classList.remove('flex'); dom.partForm.reset(); dom.specFieldsContainer.classList.add('hidden'); dom.specFields.innerHTML = ''; }
      function collectFormData() { const formData = { model: dom.partForm.querySelector('#model').value.trim(), device: dom.partForm.querySelector('#device').value, size: dom.partForm.querySelector('#size').value, itemName: dom.itemNameSelect.value, price: dom.partForm.querySelector('#price').value, quantity: dom.partForm.querySelector('#quantity').value, imageLinks: dom.imageLinksInput.value.trim(), note: dom.partForm.querySelector('#note').value.trim(), }; dom.partForm.querySelectorAll('#spec-fields input').forEach(input => { formData[input.name] = input.value.trim(); }); return formData; }
      
      function populateItemNameDropdown() {
        dom.itemNameSelect.innerHTML = '<option value="">Select item type...</option>';
        for (const itemName of itemTypeDefinitions.keys()) {
          const option = document.createElement('option');
          option.value = itemName;
          option.textContent = itemName;
          dom.itemNameSelect.appendChild(option);
        }
      }

      function updateSpecFields() { 
        const selectedType = dom.itemNameSelect.value;
        const specs = itemTypeDefinitions.get(selectedType);
        dom.specFields.innerHTML = ''; 
        if (specs && specs.length > 0) { 
          dom.specFieldsContainer.classList.remove('hidden'); 
          specs.forEach(specName => { 
            dom.specFields.appendChild(createSpecInput(specName)); 
          }); 
        } else { 
          dom.specFieldsContainer.classList.add('hidden'); 
        } 
      }
      function createSpecInput(specName) { const id = specName.replace(/_/g, '-'); const wrapper = document.createElement('div'); const labelText = specName.replace('spec_', '').replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); wrapper.innerHTML = `<label for="${id}">${labelText}</label><input type="text" id="${id}" name="${specName}" class="mt-1 industrial-input">`; return wrapper; }
      function openDetailPanel(item) { populateDetailPanel(item); dom.detailModal.classList.remove('hidden'); requestAnimationFrame(() => { dom.detailModal.classList.remove('opacity-0', 'scale-95'); trapFocus(dom.detailModal); }); }
      function closeDetailPanel() { dom.detailModal.classList.add('opacity-0', 'scale-95'); setTimeout(() => { dom.detailModal.classList.add('hidden'); }, 300); }
      function populateDetailPanel(item) {
        const images = (item.imageLinks || '').split(',').map(link => link.trim()).filter(Boolean); let teethSpecsHtml = ''; let otherSpecsHtml = ''; const teethKeys = ['spec_teeth', 'spec_numberOfTeeth', 'spec_numberOfTeethInOd', 'spec_numberOfTeethInId', 'spec_bigTeethOd', 'spec_bigTeeth', 'spec_bigTeethLength', 'spec_smallTeethOd', 'spec_smallTeeth', 'spec_smallTeethLength', 'spec_teethOd', 'spec_outsideTeeth', 'spec_insideTeeth'];
        Object.keys(item).forEach(key => { if (key.startsWith('spec_') && item[key]) { const label = key.replace('spec_', '').replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); const specRow = `<div class="flex justify-between py-2"><dt class="text-[var(--color-text-secondary)]">${label}</dt><dd class="font-semibold text-right">${item[key]}</dd></div>`; if (teethKeys.includes(key)) teethSpecsHtml += specRow; else otherSpecsHtml += specRow; } });
        dom.detailContent.innerHTML = `<div class="lg:col-span-2 p-6 flex items-center justify-center bg-[var(--color-bg-primary)] image-gallery" data-images="${images.join(',')}" data-current-index="0">${images.length > 0 ? `<div class="relative w-full h-full"><img loading="lazy" src="${getDriveThumbnail(images[0])}" class="gallery-image w-full max-h-[75vh] h-full object-contain rounded-lg" onerror="this.src='https://placehold.co/512x512/E9ECEF/212529?text=No+Image';">${images.length > 1 ? `<button aria-label="Previous image" class="detail-gallery-arrow absolute left-3 top-1/2 -translate-y-1/2 p-2 bg-black/50 rounded-full text-white hover:bg-black/75 transition-colors" data-direction="-1"><i data-lucide="chevron-left" class="pointer-events-none"></i></button><button aria-label="Next image" class="detail-gallery-arrow absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-black/50 rounded-full text-white hover:bg-black/75 transition-colors" data-direction="1"><i data-lucide="chevron-right" class="pointer-events-none"></i></button>` : ''}</div>` : `<div class="h-full flex items-center justify-center text-[var(--color-text-secondary)]">No Images</div>`}</div><div class="lg:col-span-1 p-6 space-y-6 border-l border-[var(--color-border-primary)]"><div><p class="text-sm font-bold text-[var(--color-accent-main)] uppercase">${item.itemName || 'Component'}</p><h3 class="text-3xl font-black capitalize">${[item.model, item.device, item.size].filter(Boolean).join(' ').toLowerCase()}</h3></div><div class="bg-[var(--color-bg-tertiary)] p-4 rounded-lg border border-[var(--color-border-primary)]"><h4 class="text-lg font-bold mb-3">Stock & Ordering</h4><dl class="space-y-2"><div class="flex justify-between items-baseline"><dt class="text-[var(--color-text-secondary)]">Price</dt><dd class="text-2xl font-bold">₹${item.price || 'N/A'}</dd></div><div class="flex justify-between items-baseline"><dt class="text-[var(--color-text-secondary)]">Quantity</dt><dd class="text-2xl font-bold">${item.quantity || '0'}</dd></div></dl><div class="flex items-center gap-3 mt-4"><button data-id="${item.id}" class="edit-btn btn btn--secondary flex-1"><i data-lucide="edit"></i>Edit</button><button data-id="${item.id}" class="delete-btn btn btn--danger flex-1"><i data-lucide="trash-2"></i>Delete</button></div></div>${teethSpecsHtml ? `<div><h4 class="text-lg font-bold mb-2">Teeth Details</h4><dl class="text-sm divide-y divide-[var(--color-border-primary)] border-y border-[var(--color-border-primary)]">${teethSpecsHtml}</dl></div>` : ''}${otherSpecsHtml ? `<div><h4 class="text-lg font-bold mb-2">General Specifications</h4><dl class="text-sm divide-y divide-[var(--color-border-primary)] border-y border-[var(--color-border-primary)]">${otherSpecsHtml}</dl></div>` : ''}${item.note ? `<div><h4 class="text-lg font-bold mb-2">Notes</h4><p class="text-sm p-3 bg-[var(--color-bg-tertiary)] rounded border border-[var(--color-border-primary)]">${item.note}</p></div>` : ''}</div>`;
        lucide.createIcons();
      }

      // ================================================================================
      // 6. ANALYTICS & HELPERS
      // ================================================================================
      function handleApiError(err, contextTitle) { let userMessage = 'An unexpected error occurred. Please check your connection and try again.'; const error = err.result?.error; console.error(`API Error in ${contextTitle}:`, err); if (error) { if (error.code === 403 || error.status === 'PERMISSION_DENIED') { userMessage = 'You do not have permission to perform this action. Please check your Google Sheet permissions.'; } else if (error.code === 400) { userMessage = 'The data sent was invalid. Please check the form fields and try again.'; } else if (error.code === 404) { userMessage = 'Could not find the requested data. The spreadsheet or sheet may have been moved or deleted.'; } } Swal.fire({ title: contextTitle, text: userMessage, icon: 'error' }); }
      function columnToLetter(column) { let temp, letter = ''; while (column > 0) { temp = (column - 1) % 26; letter = String.fromCharCode(temp + 65) + letter; column = (column - temp - 1) / 26; } return letter; }
      function isDuplicate() { const form = dom.partForm; const model = form.querySelector('#model').value.trim().toLowerCase(); const device = form.querySelector('#device').value.trim().toLowerCase(); const size = form.querySelector('#size').value.trim().toLowerCase(); const itemName = form.querySelector('#item-name-main').value.trim().toLowerCase(); const editId = form.querySelector('#edit-id').value; return allItems.some(item => { if (item.id === editId) return false; return (item.model || '').trim().toLowerCase() === model && (item.device || '').trim().toLowerCase() === device && (item.size || '').trim().toLowerCase() === size && (item.itemName || '').trim().toLowerCase() === itemName; }); }
      function populateFilters() { const devices = [...new Set(allItems.map(item => item.device).filter(Boolean))]; const sizes = [...new Set(allItems.map(item => item.size).filter(Boolean))]; dom.filterDevice.innerHTML = '<option value="">All Devices</option>'; devices.forEach(d => dom.filterDevice.innerHTML += `<option value="${d}">${d}</option>`); dom.filterSize.innerHTML = '<option value="">All Sizes</option>'; sizes.forEach(s => dom.filterSize.innerHTML += `<option value="${s}">${s}</option>`); }
      function updateAnalytics(items) { document.getElementById('total-components').textContent = items.length; const totalValue = items.reduce((sum, item) => sum + (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 0), 0); localStorage.setItem('inventoryTotalValue', totalValue); updateValueVisibility(); const lowStockCount = items.filter(item => (parseInt(item.quantity) || 0) < 5 && (parseInt(item.quantity) || 0) > 0).length; const lowStockEl = document.getElementById('low-stock'); lowStockEl.textContent = lowStockCount; lowStockEl.style.color = lowStockCount > 0 ? 'var(--color-status-warning)' : 'var(--color-status-success)'; const outOfStockCount = items.filter(item => (parseInt(item.quantity) || 0) === 0).length; document.getElementById('out-of-stock').textContent = outOfStockCount; }
      function toggleValueVisibility() { isValueVisible = !isValueVisible; updateValueVisibility(); }
      function updateValueVisibility() { const totalValue = parseFloat(localStorage.getItem('inventoryTotalValue') || '0'); dom.totalValue.textContent = `₹${totalValue.toLocaleString('en-IN')}`; if (isValueVisible) { dom.totalValue.classList.remove('blurred-value'); dom.valueToggleBtn.innerHTML = `<i data-lucide="eye" class="w-5 h-5"></i>`; } else { dom.totalValue.classList.add('blurred-value'); dom.valueToggleBtn.innerHTML = `<i data-lucide="eye-off" class="w-5 h-5"></i>`; } lucide.createIcons(); }
      function renderPaginationControls() { const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE); dom.paginationControls.innerHTML = ''; if (totalPages <= 1) return; let html = `<button data-page="${currentPage - 1}" class="btn btn--secondary" ${currentPage === 1 ? 'disabled' : ''}>&larr; Prev</button>`; html += `<span class="font-semibold text-[var(--color-text-secondary)]">Page ${currentPage} of ${totalPages}</span>`; html += `<button data-page="${currentPage + 1}" class="btn btn--secondary" ${currentPage === totalPages ? 'disabled' : ''}>Next &rarr;</button>`; dom.paginationControls.innerHTML = html; }
      function switchView(view) {
        document.querySelectorAll('.sidebar-nav-link').forEach(l => l.classList.remove('active'));
        dom.dashboardView.classList.add('hidden');
        dom.activityView.classList.add('hidden');
        dom.layoutSwitcher.classList.add('hidden');
        if (view === 'dashboard') {
            dom.navDashboard.classList.add('active');
            dom.dashboardView.classList.remove('hidden');
            dom.layoutSwitcher.classList.remove('hidden');
            dom.pageTitle.textContent = "Dashboard";
        } else if (view === 'activity') {
            dom.navActivity.classList.add('active');
            dom.activityView.classList.remove('hidden');
            dom.pageTitle.textContent = "Activity Log";
        }
      }
      function toggleMobileSidebar() { const isOpen = dom.sidebar.classList.toggle('open'); dom.mobileBackdrop.classList.toggle('hidden', !isOpen); }
      function trapFocus(element) { const focusableEls = element.querySelectorAll('a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="number"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])'); const firstFocusableEl = focusableEls[0]; const lastFocusableEl = focusableEls[focusableEls.length - 1]; const KEYCODE_TAB = 9; element.addEventListener('keydown', function(e) { if (e.key !== 'Tab' && e.keyCode !== KEYCODE_TAB) return; if (e.shiftKey) { if (document.activeElement === firstFocusableEl) { lastFocusableEl.focus(); e.preventDefault(); } } else { if (document.activeElement === lastFocusableEl) { firstFocusableEl.focus(); e.preventDefault(); } } }); if (firstFocusableEl) firstFocusableEl.focus(); }

      // ================================================================================
      // 8. COMPARISON
      // ================================================================================
      function updateCompareButton() { 
          const count = comparisonList.size; 
          if (count >= 2) { 
              dom.compareBtn.classList.remove('hidden'); 
              dom.compareBtn.textContent = `Compare (${count})`; 
          } else { 
              dom.compareBtn.classList.add('hidden'); 
          } 
      }
      function openComparisonModal() { 
          const itemsToCompare = allItems.filter(item => comparisonList.has(item.id)); 
          if (itemsToCompare.length < 2) return; 
          const allKeys = new Set(['itemName', 'model', 'device', 'size', 'price', 'quantity']); 
          itemsToCompare.forEach(item => { 
              Object.keys(item).forEach(key => { 
                  if (key.startsWith('spec_') && item[key]) allKeys.add(key); 
              }); 
          }); 
          let tableHTML = '<table class="w-full text-left border-collapse"><thead><tr><th class="p-3 font-semibold border-b-2 border-[var(--color-border-primary)]">Feature</th>'; 
          itemsToCompare.forEach(item => { 
              tableHTML += `<th class="p-3 font-semibold border-b-2 border-[var(--color-border-primary)] capitalize">${[item.model, item.itemName].filter(Boolean).join(' ').toLowerCase()}</th>`; 
          }); 
          tableHTML += '</tr></thead><tbody>'; 
          allKeys.forEach(key => { 
              const label = key.replace('spec_', '').replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); 
              tableHTML += `<tr class="border-b border-[var(--color-border-primary)] last:border-0"><td class="p-3 font-medium text-[var(--color-text-secondary)]">${label}</td>`; 
              itemsToCompare.forEach(item => { 
                  tableHTML += `<td class="p-3">${item[key] || 'N/A'}</td>`; 
              }); 
              tableHTML += '</tr>'; 
          }); 
          tableHTML += '</tbody></table>'; 
          dom.comparisonContent.innerHTML = tableHTML; 
          dom.comparisonModal.classList.remove('hidden'); 
          dom.comparisonModal.classList.add('flex'); 
      }
      function closeComparisonModal() { 
          dom.comparisonModal.classList.add('hidden'); 
          dom.comparisonModal.classList.remove('flex'); 
      }

      // ================================================================================
      // 9. NEW FEATURES & UI
      // ================================================================================
      function openCommandPalette() { dom.commandPalette.classList.remove('hidden'); requestAnimationFrame(() => { dom.commandPalette.classList.remove('opacity-0', '-translate-y-4'); dom.commandPaletteInput.focus(); }); }
      function closeCommandPalette() { dom.commandPalette.classList.add('opacity-0', '-translate-y-4'); setTimeout(() => { dom.commandPalette.classList.add('hidden'); dom.commandPaletteInput.value = ''; dom.commandPaletteResults.innerHTML = ''; }, 150); }
      function updateCommandPaletteResults() {
        const query = dom.commandPaletteInput.value.toLowerCase();
        const results = [];
        const commands = [ 
            { name: 'Add New Component', desc: 'Open the form to add a new part', icon: 'plus-circle', action: () => openAddModal() }, 
            { name: 'Go to Dashboard', desc: 'Navigate to the main dashboard', icon: 'layout-grid', action: () => switchView('dashboard') }, 
            { name: 'Go to Activity Log', desc: 'View change history', icon: 'history', action: () => switchView('activity') }, 
            { name: 'Toggle Theme', desc: 'Switch between light and dark mode', icon: 'sun', action: () => toggleTheme() } 
        ];
        if (query.length > 0) {
          commands.filter(c => c.name.toLowerCase().includes(query)).forEach(c => results.push({ type: 'command', ...c }));
          allItems.filter(item => Object.values(item).join(' ').toLowerCase().includes(query)).slice(0, 5).forEach(item => results.push({ type: 'item', item }));
        }
        dom.commandPaletteResults.innerHTML = results.map((r, index) => {
          if (r.type === 'command') { return `<li class="result-item p-3 rounded-lg cursor-pointer flex items-center gap-4" data-index="${index}"><i data-lucide="${r.icon}" class="w-5 h-5 text-[var(--color-text-secondary)]"></i><div><p class="font-semibold">${r.name}</p><p class="result-item-desc text-sm text-[var(--color-text-secondary)]">${r.desc}</p></div></li>`; }
          if (r.type === 'item') { const name = [r.item.model, r.item.device, r.item.size, r.item.itemName].filter(Boolean).join(' ').toLowerCase(); return `<li class="result-item p-3 rounded-lg cursor-pointer flex items-center gap-4" data-index="${index}"><i data-lucide="archive" class="w-5 h-5 text-[var(--color-text-secondary)]"></i><div><p class="font-semibold capitalize">${name}</p><p class="result-item-desc text-sm text-[var(--color-text-secondary)]">Qty: ${r.item.quantity} | Price: ₹${r.item.price || 'N/A'}</p></div></li>`; }
        }).join('');
        commandPaletteSelectedIndex = -1;
        lucide.createIcons();
      }
      function handleCommandPaletteSelection(index) {
        const query = dom.commandPaletteInput.value.toLowerCase();
        const results = [];
        const commands = [ 
            { name: 'Add New Component', desc: 'Open the form to add a new part', icon: 'plus-circle', action: () => openAddModal() }, 
            { name: 'Go to Dashboard', desc: 'Navigate to the main dashboard', icon: 'layout-grid', action: () => switchView('dashboard') }, 
            { name: 'Go to Activity Log', desc: 'View change history', icon: 'history', action: () => switchView('activity') }, 
            { name: 'Toggle Theme', desc: 'Switch between light and dark mode', icon: 'sun', action: () => toggleTheme() } 
        ];
        commands.filter(c => c.name.toLowerCase().includes(query)).forEach(c => results.push({ type: 'command', ...c }));
        allItems.filter(item => Object.values(item).join(' ').toLowerCase().includes(query)).slice(0, 5).forEach(item => results.push({ type: 'item', item }));
        
        const selected = results[index];
        if (!selected) return;
        if (selected.type === 'command') { selected.action(); }
        if (selected.type === 'item') { openDetailPanel(selected.item); }
        closeCommandPalette();
      }
      function renderNotifications() {
        let notificationsHtml = '';
        const lowStockItems = allItems.filter(item => parseInt(item.quantity) > 0 && parseInt(item.quantity) < 5);
        lowStockItems.forEach(item => {
            const name = [item.model, item.itemName].filter(Boolean).join(' ');
            notificationsHtml += `<div class="p-3 rounded-lg bg-yellow-500/10 border border-yellow-500/20"><div class="flex items-start gap-3"><i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-500 mt-1"></i><div><p class="font-semibold">Low Stock Alert</p><p class="text-sm">"${name}" has only ${item.quantity} items left.</p></div></div></div>`;
        });
        
        const recentActivity = allActivity.slice(0, 10); // Show last 10 activities
        if (recentActivity.length > 0) {
            notificationsHtml += `<h4 class="text-sm font-bold text-[var(--color-text-secondary)] px-1 pt-4 pb-2 border-b border-[var(--color-border-primary)]">Recent Activity</h4>`;
            recentActivity.forEach(n => {
                const item = allItems.find(i => i.id === n.itemId);
                const itemName = item ? [item.model, item.itemName].filter(Boolean).join(' ') : `ID: ${n.itemId}`;
                notificationsHtml += `<div class="p-3 rounded-lg hover:bg-[var(--color-bg-tertiary)]"><div class="flex items-start gap-3"><i data-lucide="history" class="w-5 h-5 text-[var(--color-text-secondary)] mt-1"></i><div><p class="text-sm"><span class="font-semibold">${n.user}</span> ${n.action.toLowerCase()}d <span class="font-semibold">${itemName}</span></p><p class="text-xs text-[var(--color-text-secondary)]">${new Date(n.timestamp).toLocaleString()}</p></div></div></div>`;
            });
        }

        dom.notificationList.innerHTML = notificationsHtml || `<p class="text-center text-[var(--color-text-secondary)] p-8">No notifications yet.</p>`;
        const hasUnread = localStorage.getItem('hasUnreadNotifications') === 'true';
        dom.notificationBellBtn.classList.toggle('has-unread', hasUnread);
        lucide.createIcons();
      }
      function renderActivityLog() {
          let activityHtml = '<table class="w-full text-left border-collapse">';
          activityHtml += '<thead><tr class="border-b-2 border-[var(--color-border-primary)]"><th class="p-4 font-semibold">Timestamp</th><th class="p-4 font-semibold">User</th><th class="p-4 font-semibold">Action</th><th class="p-4 font-semibold">Component</th><th class="p-4 font-semibold">Details</th></tr></thead>';
          activityHtml += '<tbody>';

          if (allActivity.length === 0) {
              activityHtml += '<tr><td colspan="5" class="text-center p-8 text-[var(--color-text-secondary)]">No activity has been recorded in the "AuditLog" sheet yet.</td></tr>';
          } else {
              allActivity.forEach(log => {
                  const item = allItems.find(i => i.id === log.itemId);
                  const itemName = item ? [item.model, item.itemName].filter(Boolean).join(' ') : `ID: ${log.itemId}`;
                  let detailsText = 'N/A';
                  if (log.action === 'UPDATE') {
                      try {
                          const changes = JSON.parse(log.details);
                          detailsText = Object.entries(changes).map(([key, val]) => `<li><strong>${key}:</strong> "${val.from}" &rarr; "${val.to}"</li>`).join('');
                          detailsText = `<ul class="list-disc pl-5 text-xs">${detailsText}</ul>`;
                      } catch { detailsText = 'Changes were made.'; }
                  } else if (log.action === 'CREATE' || log.action === 'DELETE') {
                      detailsText = 'Component data recorded.';
                  }

                  activityHtml += `<tr class="border-b border-[var(--color-border-primary)] last:border-b-0 text-sm hover:bg-[var(--color-bg-tertiary)]">
                      <td class="p-4 whitespace-nowrap text-[var(--color-text-secondary)]">${new Date(log.timestamp).toLocaleString()}</td>
                      <td class="p-4 font-medium">${log.user}</td>
                      <td class="p-4"><span class="font-semibold px-2 py-1 rounded text-xs ${log.action === 'CREATE' ? 'bg-green-500/20 text-green-700 dark:text-green-300' : log.action === 'DELETE' ? 'bg-red-500/20 text-red-700 dark:text-red-300' : 'bg-blue-500/20 text-blue-700 dark:text-blue-300'}">${log.action}</span></td>
                      <td class="p-4 capitalize">${itemName}</td>
                      <td class="p-4">${detailsText}</td>
                  </tr>`;
              });
          }
          activityHtml += '</tbody></table>';
          dom.activityLogContainer.innerHTML = activityHtml;
      }
      function toggleNotificationCenter() {
        const isOpen = dom.notificationCenter.classList.toggle('open');
        if (isOpen) { localStorage.setItem('hasUnreadNotifications', 'false'); dom.notificationBellBtn.classList.remove('has-unread'); }
      }
      function toggleProfileDropdown() {
        const isOpen = dom.profileDropdown.classList.toggle('hidden');
        if (isOpen) { dom.profileDropdown.classList.remove('opacity-0', 'scale-95'); }
        else { dom.profileDropdown.classList.add('opacity-0', 'scale-95'); }
      }
      function toggleSidebarCollapse() {
        dom.body.classList.toggle('sidebar-collapsed');
        localStorage.setItem('sidebarCollapsed', dom.body.classList.contains('sidebar-collapsed'));
      }
      function populateThemeSwatches() {
        const themes = [ { name: 'Gold', h: 45, s: 100, l: 52 }, { name: 'Blue', h: 217, s: 91, l: 60 }, { name: 'Green', h: 145, s: 63, l: 42 }, { name: 'Red', h: 0, s: 84, l: 60 }, { name: 'Purple', h: 262, s: 85, l: 60 } ];
        dom.themeSwatches.innerHTML = themes.map(t => `<button class="w-8 h-8 rounded-full border-2 border-[var(--color-border-primary)]" style="background-color: hsl(${t.h}, ${t.s}%, ${t.l}%)" data-h="${t.h}" data-s="${t.s}%" data-l="${t.l}%" title="${t.name}"></button>`).join('');
      }
      function applyTheme(theme) {
        dom.html.style.setProperty('--color-accent-h', theme.h);
        dom.html.style.setProperty('--color-accent-s', theme.s);
        dom.html.style.setProperty('--color-accent-l', theme.l);
        localStorage.setItem('accentColor', JSON.stringify(theme));
      }

      // ================================================================================
      // 10. EVENTS & INIT
      // ================================================================================
      function handlePaginationClick(e) { const button = e.target.closest('button'); if (button && !button.disabled) { currentPage = parseInt(button.dataset.page); renderItems(); window.scrollTo(0, 0); } }
      function handleCardClick(e) { const viewBtn = e.target.closest('.view-details-btn'); if (viewBtn) { const itemId = viewBtn.dataset.id; const item = allItems.find(i => i.id === itemId); if (item) openDetailPanel(item); return; } const checkbox = e.target.closest('.compare-checkbox'); if (checkbox) { const itemId = checkbox.dataset.id; if (checkbox.checked) comparisonList.add(itemId); else comparisonList.delete(itemId); updateCompareButton(); } }
      function handleDetailPanelClick(e) {
        const editBtn = e.target.closest('.edit-btn'); const deleteBtn = e.target.closest('.delete-btn'); const arrowBtn = e.target.closest('.detail-gallery-arrow');
        if (editBtn) { const itemId = editBtn.dataset.id; const item = allItems.find(i => i.id === itemId); if (item) { closeDetailPanel(); openEditModal(item); } }
        if (deleteBtn) { const itemId = deleteBtn.dataset.id; Swal.fire({ title: 'Are you absolutely sure?', text: "This action cannot be undone!", icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, delete it!', confirmButtonColor: '#d33', cancelButtonText: 'Cancel' }).then((result) => { if (result.isConfirmed) deleteComponent(itemId); }); }
        if (arrowBtn) { const gallery = arrowBtn.closest('.image-gallery'); const images = (gallery.dataset.images || '').split(',').map(link => link.trim()).filter(Boolean); if (images.length <= 1) return; let currentIndex = parseInt(gallery.dataset.currentIndex || '0'); const direction = parseInt(arrowBtn.dataset.direction); currentIndex = (currentIndex + direction + images.length) % images.length; gallery.querySelector('.gallery-image').src = getDriveThumbnail(images[currentIndex]); gallery.dataset.currentIndex = currentIndex; }
      }
      
      // Initialize app
      initThemeAndLayout();
      gapi.load('client', initializeGapiClient);
      const gisScript = document.createElement('script'); gisScript.src = 'https://accounts.google.com/gsi/client'; gisScript.async = true; gisScript.defer = true; gisScript.onload = initializeGis;
      document.body.appendChild(gisScript);

      // Event Listeners
      dom.partForm.addEventListener('submit', handleFormSubmit);
      dom.search.addEventListener('input', () => { clearTimeout(searchDebounceTimer); searchDebounceTimer = setTimeout(() => { currentPage = 1; processAndRenderItems(); }, 300); });
      [dom.filterDevice, dom.filterSize, dom.sortBy].forEach(el => el.addEventListener('change', () => { currentPage = 1; processAndRenderItems(); }));
      dom.closeFormModalBtn.addEventListener('click', closeFormModal);
      dom.cancelBtn.addEventListener('click', closeFormModal);
      dom.menuBtn.addEventListener('click', toggleMobileSidebar);
      dom.mobileBackdrop.addEventListener('click', toggleMobileSidebar);
      dom.itemNameSelect.addEventListener('change', updateSpecFields);
      dom.gridViewBtn.addEventListener('click', () => switchLayout('grid'));
      dom.tableViewBtn.addEventListener('click', () => switchLayout('table'));
      dom.themeToggle.addEventListener('click', toggleTheme);
      dom.detailCloseBtn.addEventListener('click', closeDetailPanel);
      dom.detailBackdrop.addEventListener('click', closeDetailPanel);
      dom.searchResults.addEventListener('click', handleCardClick);
      dom.detailContent.addEventListener('click', handleDetailPanelClick);
      dom.paginationControls.addEventListener('click', handlePaginationClick);
      [dom.navDashboard, dom.navActivity].forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const view = e.currentTarget.id.replace('nav-', ''); switchView(view); if (window.innerWidth < 1024) toggleMobileSidebar(); }); });
      dom.valueToggleBtn.addEventListener('click', toggleValueVisibility);
      dom.compareBtn.addEventListener('click', openComparisonModal);
      dom.closeComparisonModalBtn.addEventListener('click', closeComparisonModal);
      dom.searchShortcutBtn.addEventListener('click', openCommandPalette);
      dom.commandPalette.addEventListener('click', (e) => { if (e.target === dom.commandPalette) closeCommandPalette(); });
      dom.commandPaletteInput.addEventListener('input', updateCommandPaletteResults);
      dom.commandPaletteResults.addEventListener('click', (e) => { const item = e.target.closest('.result-item'); if (item) { handleCommandPaletteSelection(parseInt(item.dataset.index)); } });
      dom.notificationBellBtn.addEventListener('click', toggleNotificationCenter);
      dom.notificationCloseBtn.addEventListener('click', toggleNotificationCenter);
      dom.profileBtn.addEventListener('click', toggleProfileDropdown);
      dom.sidebarCollapseBtn.addEventListener('click', toggleSidebarCollapse);
      dom.addItemHeaderBtn.addEventListener('click', openAddModal);
      dom.themeSwatches.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { applyTheme(e.target.dataset); } });
      dom.refreshBtn.addEventListener('click', () => loadAllData(true));
      dom.settingsBtn.addEventListener('click', () => {
          const isHidden = dom.settingsDropdown.classList.toggle('hidden');
          if (!isHidden) {
              dom.settingsDropdown.classList.remove('opacity-0', 'scale-95');
          } else {
              dom.settingsDropdown.classList.add('opacity-0', 'scale-95');
          }
      });
      dom.manageItemTypesBtn.addEventListener('click', () => {
          dom.itemTypesModal.classList.remove('hidden');
          dom.itemTypesModal.classList.add('flex');
          renderItemTypesList();
      });
      dom.closeItemTypesModalBtn.addEventListener('click', () => {
          dom.itemTypesModal.classList.add('hidden');
          dom.itemTypesModal.classList.remove('flex');
      });
      dom.addNewItemTypeBtn.addEventListener('click', () => {
          dom.itemTypeFormContainer.classList.remove('hidden');
          dom.itemTypeForm.reset();
          dom.itemTypeForm.querySelector('#item-type-edit-name').value = '';
          dom.itemTypeForm.querySelector('#item-type-name').disabled = false;
      });
      dom.cancelItemTypeBtn.addEventListener('click', () => {
          dom.itemTypeFormContainer.classList.add('hidden');
          dom.itemTypeForm.reset();
      });
      dom.itemTypeForm.addEventListener('submit', handleItemTypeFormSubmit);
      
      // Global Listeners
      document.addEventListener('click', (e) => {
        if (!dom.profileBtn.contains(e.target) && !dom.profileDropdown.contains(e.target) && !dom.profileDropdown.classList.contains('hidden')) { toggleProfileDropdown(); }
        if (!dom.settingsBtn.contains(e.target) && !dom.settingsDropdown.contains(e.target) && !dom.settingsDropdown.classList.contains('hidden')) {
            dom.settingsDropdown.classList.add('opacity-0', 'scale-95');
            setTimeout(() => dom.settingsDropdown.classList.add('hidden'), 150);
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (!dom.commandPalette.classList.contains('hidden')) closeCommandPalette();
          else if (!dom.detailModal.classList.contains('hidden')) closeDetailPanel();
          else if (!dom.formModal.classList.contains('hidden')) closeFormModal();
          else if (dom.notificationCenter.classList.contains('open')) toggleNotificationCenter();
        }
        if (e.ctrlKey && e.key === 'k') { e.preventDefault(); openCommandPalette(); }
        if (e.ctrlKey && e.key === 's' && !dom.formModal.classList.contains('hidden')) { e.preventDefault(); dom.saveBtn.click(); }
        
        if (!dom.commandPalette.classList.contains('hidden')) {
          const results = dom.commandPaletteResults.querySelectorAll('.result-item');
          if (results.length === 0) return;
          if (e.key === 'ArrowDown') { e.preventDefault(); commandPaletteSelectedIndex = (commandPaletteSelectedIndex + 1) % results.length; }
          else if (e.key === 'ArrowUp') { e.preventDefault(); commandPaletteSelectedIndex = (commandPaletteSelectedIndex - 1 + results.length) % results.length; }
          else if (e.key === 'Enter') { e.preventDefault(); handleCommandPaletteSelection(commandPaletteSelectedIndex); }
          results.forEach((r, i) => r.classList.toggle('selected', i === commandPaletteSelectedIndex));
        }
      });
    });
  </script>
</body>
</html>
