<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vinayaka | Component Database</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ==========================================================================
           VINAYAKA INDUSTRIES :: COMPONENT DATABASE STYLESHEET
           Author: 10+ Yr Sr. Web Developer
           Methodology: A token-based design system for maximum scalability,
                        inspired by enterprise-grade application architecture.
           ========================================================================== */

        /* ==========================================================================
           1. SETTINGS :: Design Tokens & Global Variables
           ========================================================================== */
        :root {
            /* ┌────────────────────────────────────────────────────────────────────┐
             │ A. CORE LAYOUT & SIZING                                            │
             └────────────────────────────────────────────────────────────────────┘ */
            --sidebar-width: 260px;
            --header-height: 72px;

            /* ┌────────────────────────────────────────────────────────────────────┐
             │ B. TYPOGRAPHY                                                      │
             └────────────────────────────────────────────────────────────────────┘ */
            --font-family-base: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --font-weight-black: 800;

            /* ┌────────────────────────────────────────────────────────────────────┐
             │ C. SPACING SCALE (8px Grid)                                        │
             └────────────────────────────────────────────────────────────────────┘ */
            --space-1: 0.25rem;  /* 4px  */
            --space-2: 0.5rem;   /* 8px  */
            --space-3: 0.75rem;  /* 12px */
            --space-4: 1rem;     /* 16px */
            --space-5: 1.25rem;  /* 20px */
            --space-6: 1.5rem;   /* 24px */
            --space-8: 2rem;     /* 32px */

            /* ┌────────────────────────────────────────────────────────────────────┐
             │ D. BORDERS & RADII                                                 │
             └────────────────────────────────────────────────────────────────────┘ */
            --border-width: 1px;
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;

            /* ┌────────────────────────────────────────────────────────────────────┐
             │ E. TRANSITIONS & ANIMATIONS                                        │
             └────────────────────────────────────────────────────────────────────┘ */
            --transition-speed-fast: 150ms;
            --transition-speed-normal: 300ms;
            --transition-curve-bounce: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-curve-smooth: ease-in-out;

            /* ┌────────────────────────────────────────────────────────────────────┐
             │ F. LIGHT THEME PALETTE                                             │
             └────────────────────────────────────────────────────────────────────┘ */
            --color-bg-primary: #F8F9FA;
            --color-bg-secondary: #FFFFFF;
            --color-bg-tertiary: #E9ECEF;

            --color-text-primary: #212529;
            --color-text-secondary: #6C757D;
            --color-text-on-accent: #212529;
            --color-text-on-danger: #FFFFFF;

            --color-border-primary: #DEE2E6;
            --color-border-focus: var(--color-accent-main);

            --color-accent-main: #FFC107;
            --color-accent-focus-ring: rgb(255 193 7 / 25%);

            --color-status-danger: #DC3545;
            --color-status-warning: #FD7E14;
            --color-status-success: #198754;

            --shadow-color: 220 23% 10%;
            --shadow-elevation-low:
                0.3px 0.5px 0.7px hsl(var(--shadow-color) / 0.11),
                0.4px 0.8px 1px -1.2px hsl(var(--shadow-color) / 0.11),
                1px 2px 2.5px -2.5px hsl(var(--shadow-color) / 0.11);
            --shadow-elevation-medium:
                0.3px 0.5px 0.7px hsl(var(--shadow-color) / 0.1),
                0.8px 1.6px 2px -0.8px hsl(var(--shadow-color) / 0.1),
                2.1px 4.1px 5.2px -1.7px hsl(var(--shadow-color) / 0.1),
                5px 10px 12.6px -2.5px hsl(var(--shadow-color) / 0.1);
        }

        html.dark {
            /* ┌────────────────────────────────────────────────────────────────────┐
             │ G. DARK THEME OVERRIDES                                            │
             └────────────────────────────────────────────────────────────────────┘ */
            --color-bg-primary: #121212;
            --color-bg-secondary: #1E1E1E;
            --color-bg-tertiary: #2C2C2C;

            --color-text-primary: #EAEAEA;
            --color-text-secondary: #888888;

            --color-border-primary: #3A3A3A;

            --color-status-danger: #EF5350;
            --color-status-warning: #FFA726;
            --color-status-success: #4CAF50;

            --shadow-color: 220 23% 5%;
        }


        /* ==========================================================================
           2. GENERIC :: Reset & Normalizations
           ========================================================================== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family-base);
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
            line-height: 1.6;
            transition: background-color var(--transition-speed-normal) var(--transition-curve-smooth),
                        color var(--transition-speed-normal) var(--transition-curve-smooth);
        }

        /* ==========================================================================
           3. BASE :: Unclassed HTML Elements
           ========================================================================== */
        h1, h2, h3, h4, h5, h6 {
            font-weight: var(--font-weight-black);
            line-height: 1.2;
        }

        /* ==========================================================================
           4. OBJECTS :: Layout-related classes
           ========================================================================== */
        .main-content {
            padding-left: var(--sidebar-width);
            transition: padding-left var(--transition-speed-normal) var(--transition-curve-bounce);
        }

        /* ==========================================================================
           5. COMPONENTS :: Styled, reusable UI patterns
           ========================================================================== */

        /* -------------------------------------------------------------------------- */
        /* A. SIDEBAR                                                                 */
        /* -------------------------------------------------------------------------- */
        .sidebar {
            background-color: var(--color-bg-secondary);
            border-right: var(--border-width) solid var(--color-border-primary);
            transition: transform var(--transition-speed-normal) var(--transition-curve-bounce);
            height: 100vh;
        }

        .sidebar-nav-link {
            position: relative;
            transition: background-color var(--transition-speed-fast) var(--transition-curve-smooth),
                        color var(--transition-speed-fast) var(--transition-curve-smooth);
        }

        .sidebar-nav-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            width: 4px;
            height: 60%;
            background-color: var(--color-accent-main);
            border-radius: 0 4px 4px 0;
            transform: translateY(-50%) scaleY(0);
            transition: transform var(--transition-speed-fast) var(--transition-curve-bounce);
        }

        .sidebar-nav-link:hover:not(.active) {
            background-color: var(--color-bg-tertiary);
        }
        .sidebar-nav-link:hover::before {
            transform: translateY(-50%) scaleY(1);
        }

        .sidebar-nav-link.active {
            background-color: var(--color-accent-main);
            color: var(--color-text-on-accent);
            font-weight: var(--font-weight-bold);
        }
        .sidebar-nav-link.active::before {
            transform: translateY(-50%) scaleY(1);
        }

        /* -------------------------------------------------------------------------- */
        /* B. CARD                                                                    */
        /* -------------------------------------------------------------------------- */
        .industrial-card {
            background-color: var(--color-bg-secondary);
            border: var(--border-width) solid var(--color-border-primary);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-elevation-low);
            transition: transform var(--transition-speed-fast) var(--transition-curve-bounce),
                        box-shadow var(--transition-speed-fast) var(--transition-curve-bounce),
                        border-color var(--transition-speed-fast) var(--transition-curve-smooth);
        }

        .industrial-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-elevation-medium);
            border-color: var(--color-accent-main);
        }

        /* -------------------------------------------------------------------------- */
        /* C. BUTTON                                                                  */
        /* -------------------------------------------------------------------------- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-sm);
            font-weight: var(--font-weight-bold);
            text-align: center;
            border: var(--border-width) solid transparent;
            cursor: pointer;
            transition: transform var(--transition-speed-fast) var(--transition-curve-bounce),
                        box-shadow var(--transition-speed-fast) var(--transition-curve-bounce),
                        background-color var(--transition-speed-fast) var(--transition-curve-smooth),
                        border-color var(--transition-speed-fast) var(--transition-curve-smooth);
            user-select: none;
        }

        .btn:focus-visible {
            outline: 2px solid var(--color-accent-main);
            outline-offset: 2px;
        }

        .btn--primary {
            background-color: var(--color-accent-main);
            color: var(--color-text-on-accent);
            border-bottom: 3px solid color-mix(in srgb, var(--color-text-primary) 25%, transparent);
        }
        .btn--primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-elevation-low);
        }
        .btn--primary:active {
            transform: translateY(1px);
            border-bottom-width: 1px;
        }

        .btn--secondary {
            background-color: transparent;
            color: var(--color-text-primary);
            border-color: var(--color-border-primary);
        }
        .btn--secondary:hover {
            background-color: var(--color-bg-tertiary);
            border-color: var(--color-text-primary);
        }

        .btn--danger {
            background-color: transparent;
            color: var(--color-status-danger);
            border-color: var(--color-status-danger);
        }
        .btn--danger:hover {
            background-color: var(--color-status-danger);
            color: var(--color-text-on-danger);
        }

        /* -------------------------------------------------------------------------- */
        /* D. FORMS                                                                   */
        /* -------------------------------------------------------------------------- */
        .filter-control-group {
            background-color: var(--color-bg-tertiary);
            border: var(--border-width) solid var(--color-border-primary);
            border-radius: var(--radius-md);
            padding: var(--space-1) var(--space-3);
            transition: border-color var(--transition-speed-fast) var(--transition-curve-smooth),
                        box-shadow var(--transition-speed-fast) var(--transition-curve-smooth);
        }

        .filter-control-group:focus-within {
            border-color: var(--color-border-focus);
            box-shadow: 0 0 0 3px var(--color-accent-focus-ring);
        }

        .filter-control-group label {
            font-size: 0.7rem;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            display: block;
        }

        .filter-control-input {
            background-color: transparent;
            border: none;
            outline: none;
            width: 100%;
            padding: 0.1rem 0;
            color: var(--color-text-primary);
            font-weight: var(--font-weight-medium);
            font-family: inherit;
        }

        .filter-control-input::placeholder {
            color: var(--color-text-secondary);
            opacity: 0.8;
        }

        .industrial-input {
            background-color: transparent;
            border: none;
            border-bottom: 2px solid var(--color-border-primary);
            border-radius: 0;
            padding: var(--space-3) var(--space-1);
            width: 100%;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color var(--transition-speed-fast) var(--transition-curve-smooth);
        }

        .industrial-input:focus {
            outline: none;
            border-bottom-color: var(--color-border-focus);
            --tw-ring-color: transparent;
        }

        /* -------------------------------------------------------------------------- */
        /* E. UTILITY & MISC COMPONENTS                                               */
        /* -------------------------------------------------------------------------- */
        .blurred-value {
            filter: blur(8px);
            user-select: none;
            cursor: pointer;
            transition: filter var(--transition-speed-normal) var(--transition-curve-smooth);
        }

        /* SweetAlert2 Theming */
        .swal2-popup {
            font-family: var(--font-family-base);
            background-color: var(--color-bg-secondary) !important;
            color: var(--color-text-primary) !important;
            border: var(--border-width) solid var(--color-border-primary) !important;
            border-radius: var(--radius-lg) !important;
        }
        .swal2-title { color: var(--color-text-primary) !important; }
        .swal2-confirm { background-color: var(--color-accent-main) !important; color: var(--color-text-on-accent) !important; }
        .swal2-deny { background-color: var(--color-status-danger) !important; }
        .swal2-cancel { background-color: var(--color-bg-tertiary) !important; }

        /* Skeleton Loader Animation */
        @keyframes breathing {
            0%, 100% { background-color: var(--color-bg-tertiary); }
            50% { background-color: color-mix(in srgb, var(--color-bg-tertiary) 80%, var(--color-bg-secondary)); }
        }
        .skeleton-breathe .skeleton-item {
            animation: breathing 2s var(--transition-curve-bounce) infinite;
        }
        .skeleton-breathe .skeleton-item:nth-child(2n) { animation-delay: 100ms; }
        .skeleton-breathe .skeleton-item:nth-child(3n) { animation-delay: 200ms; }


        /* ==========================================================================
           6. MEDIA QUERIES :: Responsive Breakpoints
           ========================================================================== */
        @media (max-width: 1024px) {
            .main-content { padding-left: 0; }
            .sidebar {
                transform: translateX(-100%);
                box-shadow: 5px 0 15px rgba(0,0,0,0.2);
                z-index: 50;
            }
            .sidebar.open { transform: translateX(0); }
            .mobile-backdrop {
                position: fixed;
                inset: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 49;
                transition: opacity var(--transition-speed-normal) var(--transition-curve-smooth);
            }
        }
    </style>
</head>
<body class="antialiased">

    <div id="login-view" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-8 bg-[var(--color-bg-primary)]">
        <div class="text-center">
            <div class="inline-block bg-[var(--color-text-primary)] p-4 rounded-lg mb-6">
                <i data-lucide="gem" class="w-12 h-12 text-[var(--color-bg-primary)]"></i>
            </div>
            <h1 class="text-4xl font-black">Welcome to Vinayaka Industries DB</h1>
            <p class="text-lg text-[var(--color-text-secondary)] mt-2 mb-8">The Professional Component Inventory Platform.</p>
            <button id="signin-button-main" class="btn btn--primary text-lg">Sign In with Google</button>
        </div>
    </div>

    <div id="app-wrapper" class="relative min-h-screen hidden">
        <div id="mobile-backdrop" class="mobile-backdrop hidden lg:hidden"></div>

        <aside class="sidebar fixed top-0 left-0 w-[var(--sidebar-width)] flex flex-col">
            <div class="flex items-center gap-4 p-5 h-[var(--header-height)] border-b border-[var(--color-border-primary)] flex-shrink-0">
                <div class="bg-[var(--color-text-primary)] p-2.5 rounded-lg"><i data-lucide="gem" class="w-6 h-6 text-[var(--color-bg-primary)]"></i></div>
                <h1 class="text-xl font-black">Vinayaka Industries</h1>
            </div>
            
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="#" id="nav-dashboard" class="sidebar-nav-link active flex items-center gap-4 px-4 py-3 rounded-lg">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i><span>Dashboard</span>
                </a>
                <a href="#" id="nav-reports" class="sidebar-nav-link flex items-center gap-4 px-4 py-3 text-[var(--color-text-secondary)] rounded-lg font-medium">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i><span>Reports</span>
                </a>
            </nav>

            <div class="p-4 border-t border-[var(--color-border-primary)] flex-shrink-0">
                <div id="user-profile-area">
                    <div id="auth-signed-out-view" class="p-2 rounded-lg cursor-pointer group hover:bg-[var(--color-bg-tertiary)] transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-11 h-11 rounded-full bg-[var(--color-bg-tertiary)] flex items-center justify-center border border-dashed border-[var(--color-border-primary)]"><i data-lucide="user-x" class="text-[var(--color-text-secondary)]"></i></div>
                            <div>
                                <p class="font-semibold text-[var(--color-text-secondary)]">Not Signed In</p>
                                <p class="text-xs text-[var(--color-text-secondary)] group-hover:text-[var(--color-accent-main)] transition-colors">Click to sign in</p>
                            </div>
                        </div>
                    </div>
                    <div id="auth-signed-in-view" class="hidden">
                        <div class="flex items-center justify-between p-2">
                            <div class="flex items-center gap-3">
                                <img id="user-dp" class="w-11 h-11 rounded-full" src="" alt="User profile picture">
                                <div>
                                    <p id="user-name" class="font-semibold"></p>
                                    <p class="text-xs text-[var(--color-status-success)] font-medium">Online</p>
                                </div>
                            </div>
                            <button id="sign-out-btn" aria-label="Sign out" class="p-2 rounded-full hover:bg-[var(--color-bg-tertiary)] text-[var(--color-text-secondary)] transition-colors">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mt-2 flex items-center justify-between p-2">
                    <label for="theme-toggle" class="text-sm font-medium text-[var(--color-text-secondary)]">Theme</label>
                    <button id="theme-toggle" aria-label="Toggle light and dark theme" class="p-2 rounded-full hover:bg-[var(--color-bg-tertiary)] text-[var(--color-text-secondary)] transition-colors">
                        <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                        <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                    </button>
                </div>
            </div>
        </aside>

        <main class="main-content flex-1 flex flex-col min-h-screen">
            <header class="sticky top-0 z-30 bg-[var(--color-bg-primary)]/80 backdrop-blur-sm h-[var(--header-height)] flex items-center justify-between px-6 lg:px-8 border-b border-[var(--color-border-primary)]">
                <div class="flex items-center gap-4">
                    <button id="menuBtn" aria-label="Open sidebar menu" class="lg:hidden p-2 text-[var(--color-text-secondary)] -ml-2"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <h2 class="text-2xl font-black" id="page-title">Dashboard</h2>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <div id="layout-switcher" class="flex items-center gap-1 bg-[var(--color-bg-tertiary)] p-1 rounded-lg border border-[var(--color-border-primary)]">
                        <button id="grid-view-btn" aria-label="Switch to grid view" class="p-2 rounded-md"><i data-lucide="layout-grid"></i></button>
                        <button id="list-view-btn" aria-label="Switch to list view" class="p-2 rounded-md"><i data-lucide="list"></i></button>
                        <button id="table-view-btn" aria-label="Switch to table view" class="p-2 rounded-md"><i data-lucide="table-2"></i></button>
                        <button id="kanban-view-btn" aria-label="Switch to kanban view" class="p-2 rounded-md"><i data-lucide="trello"></i></button>
                    </div>
                    <button id="compare-btn" class="btn btn--secondary hidden">Compare (0)</button>
                    <button id="addPartBtn" class="btn btn--primary disabled:bg-gray-400 disabled:text-gray-600 disabled:cursor-not-allowed disabled:border-b-0" disabled>
                        <i data-lucide="plus" class="w-5 h-5"></i><span class="hidden sm:inline">Add Component</span>
                    </button>
                </div>
            </header>

            <div id="app" class="flex-1 w-full p-6 lg:p-8">
                <div id="dashboard-view">
                    <div class="mb-8">
                        <h2 class="text-2xl font-black mb-4">Analytics Overview</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="industrial-card p-6 flex flex-col justify-between">
                                <p class="text-sm font-semibold text-[var(--color-text-secondary)] opacity-80">Total Components</p>
                                <p id="total-components" class="text-3xl sm:text-4xl xl:text-5xl font-black mt-2">0</p>
                            </div>
                            <div class="industrial-card p-6 flex flex-col justify-between">
                                <div class="flex justify-between items-start">
                                    <p class="text-sm font-semibold text-[var(--color-text-secondary)] opacity-80">Inventory Value</p>
                                    <button id="value-toggle-btn" aria-label="Toggle inventory value visibility" class="text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)]"><i data-lucide="eye-off" class="w-5 h-5"></i></button>
                                </div>
                                <p id="total-value" class="text-3xl sm:text-4xl xl:text-5xl font-black mt-2">₹0</p>
                            </div>
                            <div class="industrial-card p-6 flex flex-col justify-between">
                                <p class="text-sm font-semibold text-[var(--color-text-secondary)] opacity-80">Low Stock Items</p>
                                <p id="low-stock" class="text-3xl sm:text-4xl xl:text-5xl font-black mt-2">0</p>
                            </div>
                            <div class="industrial-card p-6 flex flex-col justify-between">
                                <p class="text-sm font-semibold text-[var(--color-text-secondary)] opacity-80">Out of Stock</p>
                                <p id="out-of-stock" class="text-3xl sm:text-4xl xl:text-5xl font-black mt-2 text-[var(--color-status-danger)]">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg p-4 mb-8">
                        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                            <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div class="lg:col-span-1">
                                    <div class="filter-control-group flex items-center gap-2">
                                        <i data-lucide="search" class="w-5 h-5 text-[var(--color-text-secondary)] flex-shrink-0"></i>
                                        <input type="text" id="search" placeholder="Search components..." class="filter-control-input">
                                    </div>
                                </div>
                                <div>
                                    <div class="filter-control-group">
                                        <label for="filter-device">Device</label>
                                        <select id="filter-device" class="filter-control-input"><option value="">All Devices</option></select>
                                    </div>
                                </div>
                                <div>
                                    <div class="filter-control-group">
                                        <label for="filter-size">Size</label>
                                        <select id="filter-size" class="filter-control-input"><option value="">All Sizes</option></select>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-shrink-0">
                                <div class="filter-control-group">
                                    <label for="sort-by">Sort By</label>
                                    <select id="sort-by" class="filter-control-input"><option value="model-asc">Model (A-Z)</option><option value="price-desc">Price (High-Low)</option><option value="quantity-asc">Quantity (Low-High)</option></select>
                                </div>
                            </div>
                        </div>
                    </div>
                
                    <div id="skeleton-loader" class="hidden"></div>
                    <div id="searchResults" class="hidden"></div>
                    <div id="no-results" class="hidden text-center py-16 industrial-card"><i data-lucide="search-x" class="w-16 h-16 mx-auto text-[var(--color-text-secondary)]"></i><h3 class="mt-4 text-2xl font-bold">No Components Found</h3><p class="mt-2 text-[var(--color-text-secondary)]">Your database is empty or your search returned no results.</p></div>
                
                    <div id="pagination-controls" class="flex justify-center items-center gap-4 mt-8"></div>
                </div>

                <div id="reports-view" class="hidden space-y-8">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="industrial-card p-6"><h3 class="font-semibold mb-4">Monthly Revenue</h3><canvas id="revenue-chart"></canvas></div>
                        <div class="industrial-card p-6"><h3 class="font-semibold mb-4">Best Selling Items (by Quantity)</h3><canvas id="bestsellers-chart"></canvas></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="formModal" role="dialog" aria-modal="true" aria-labelledby="form-title" class="fixed inset-0 z-50 justify-center items-start p-4 overflow-y-auto bg-black/70 hidden">
        <div class="bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg shadow-2xl w-full max-w-4xl my-8 flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-[var(--color-border-primary)]"><h2 id="form-title" class="text-2xl font-black">Add New Component</h2><button type="button" id="closeFormModalBtn" aria-label="Close form" class="text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <form id="partForm" class="p-6 space-y-6 overflow-y-auto">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div><label for="model">Model*</label><input type="text" id="model" required class="mt-1 industrial-input"></div>
                    <div><label for="device">Device</label><select id="device" class="mt-1 industrial-input"><option value="">(None)</option><option value="SWING DEVICE">Swing Device</option><option value="TRAVEL DEVICE">Travel Device</option></select></div>
                    <div><label for="size">Size</label><select id="size" class="mt-1 industrial-input"><option value="">(None)</option><option value="SMALL">Small</option><option value="MIDDLE">Middle</option><option value="BIG">Big</option></select></div>
                    <div><label for="item-name-main">Item Name*</label><select id="item-name-main" required class="mt-1 industrial-input"><option value="">Select item type...</option><option value="Planetary Gear">Planetary Gear</option><option value="Sun Gear">Sun Gear</option><option value="Ring Gear">Ring Gear</option><option value="Spline/Pinion Shaft">Spline/Pinion Shaft</option><option value="Track Motor Shaft">Track Motor Shaft</option><option value="Bearing">Bearing</option><option value="Bushes">Bushes</option></select></div>
                    <div><label for="price">Price</label><input type="number" id="price" placeholder="e.g., 4500" class="mt-1 industrial-input"></div>
                    <div><label for="quantity">Quantity*</label><input type="number" id="quantity" required value="1" min="0" class="mt-1 industrial-input"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label for="image-links-input">Image Links (comma-separated)</label><textarea id="image-links-input" placeholder="Paste one or more comma-separated Google Drive links..." class="industrial-input mt-1" rows="3"></textarea></div>
                    <div><label for="note">Note</label><textarea id="note" rows="3" class="mt-1 industrial-input"></textarea></div>
                </div>
                <div id="spec-fields-container" class="hidden"><h3 class="text-lg font-bold border-b border-[var(--color-border-primary)] pb-2 mb-4">Specifications</h3><div id="spec-fields" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-4"></div></div>
            </form>
            <div class="p-6 border-t border-[var(--color-border-primary)] bg-[var(--color-bg-primary)] flex justify-end gap-3"><button type="button" id="cancelBtn" class="btn btn--secondary">Cancel</button><button type="submit" form="partForm" class="btn btn--primary">Save Component</button></div>
        </div>
    </div>

    <div id="detail-modal" role="dialog" aria-modal="true" aria-labelledby="detail-title" class="fixed inset-0 z-50 justify-center items-center p-4 hidden opacity-0 scale-95 transition-all duration-300">
        <div class="fixed inset-0 bg-black/70" id="detail-backdrop"></div>
        <div class="relative bg-[var(--color-bg-secondary)] w-full max-w-6xl max-h-[90vh] rounded-lg border border-[var(--color-border-primary)] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-[var(--color-border-primary)] flex-shrink-0">
                <h2 id="detail-title" class="text-xl font-black">Component Datasheet</h2>
                <button id="detail-close-btn" aria-label="Close details panel" class="p-2 text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] rounded-full hover:bg-[var(--color-bg-tertiary)]"><i data-lucide="x"></i></button>
            </div>
            <div id="detail-content" class="grid lg:grid-cols-3 gap-0 overflow-y-auto">
                </div>
        </div>
    </div>

    <div id="comparison-modal" role="dialog" aria-modal="true" aria-labelledby="comparison-title" class="fixed inset-0 z-50 justify-center items-start p-4 overflow-y-auto bg-black/70 hidden">
        <div class="bg-[var(--color-bg-secondary)] border border-[var(--color-border-primary)] rounded-lg shadow-2xl w-full max-w-7xl my-8 flex flex-col">
            <div class="flex justify-between items-center p-6 border-b border-[var(--color-border-primary)]"><h2 id="comparison-title" class="text-2xl font-black">Compare Components</h2><button type="button" id="closeComparisonModalBtn" aria-label="Close comparison" class="text-[var(--color-text-secondary)] hover:text-[var(--color-text-primary)] transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div id="comparison-content" class="p-6 overflow-x-auto"></div>
        </div>
    </div>
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ================================================================================
        // 1. CONFIGURATION & STATE MANAGEMENT
        // ================================================================================
        const API_KEY = 'YOUR_API_KEY'; // Replace with your API key
        const CLIENT_ID = 'YOUR_CLIENT_ID.apps.googleusercontent.com'; // Replace with your Client ID
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile";
        const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID'; // Replace with your Spreadsheet ID
        const INVENTORY_RANGE = 'Sheet1!A:ZZ'; // Use a wide range to ensure all columns are read
        const SALES_RANGE = 'SalesLog!A:D';

        let allItems = [];
        let allSales = [];
        let filteredItems = [];
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let sheetHeaders = []; // To store actual headers from the sheet
        let currentLayout = 'grid';
        let currentPage = 1;
        const ITEMS_PER_PAGE = 12;
        let revenueChart, bestsellersChart;
        let isValueVisible = false;
        let searchDebounceTimer;
        let comparisonList = new Set();

        const dom = {
            html: document.documentElement,
            appWrapper: document.getElementById('app-wrapper'),
            loginView: document.getElementById('login-view'),
            addPartBtn: document.getElementById('addPartBtn'),
            searchResults: document.getElementById('searchResults'),
            noResults: document.getElementById('no-results'),
            userProfileArea: document.getElementById('user-profile-area'),
            authSignedInView: document.getElementById('auth-signed-in-view'),
            authSignedOutView: document.getElementById('auth-signed-out-view'),
            signOutBtn: document.getElementById('sign-out-btn'),
            userDp: document.getElementById('user-dp'),
            userName: document.getElementById('user-name'),
            signInButtonMain: document.getElementById('signin-button-main'),
            partForm: document.getElementById('partForm'),
            formTitle: document.getElementById('form-title'),
            editId: document.getElementById('edit-id'),
            itemNameSelect: document.getElementById('item-name-main'),
            specFieldsContainer: document.getElementById('spec-fields-container'),
            specFields: document.getElementById('spec-fields'),
            search: document.getElementById('search'),
            formModal: document.getElementById('formModal'),
            closeFormModalBtn: document.getElementById('closeFormModalBtn'),
            cancelBtn: document.getElementById('cancelBtn'),
            imageLinksInput: document.getElementById('image-links-input'),
            skeletonLoader: document.getElementById('skeleton-loader'),
            menuBtn: document.getElementById('menuBtn'),
            sidebar: document.querySelector('.sidebar'),
            gridViewBtn: document.getElementById('grid-view-btn'),
            listViewBtn: document.getElementById('list-view-btn'),
            tableViewBtn: document.getElementById('table-view-btn'),
            kanbanViewBtn: document.getElementById('kanban-view-btn'),
            themeToggle: document.getElementById('theme-toggle'),
            detailModal: document.getElementById('detail-modal'),
            detailBackdrop: document.getElementById('detail-backdrop'),
            detailContent: document.getElementById('detail-content'),
            detailCloseBtn: document.getElementById('detail-close-btn'),
            filterDevice: document.getElementById('filter-device'),
            filterSize: document.getElementById('filter-size'),
            sortBy: document.getElementById('sort-by'),
            paginationControls: document.getElementById('pagination-controls'),
            navDashboard: document.getElementById('nav-dashboard'),
            navReports: document.getElementById('nav-reports'),
            dashboardView: document.getElementById('dashboard-view'),
            reportsView: document.getElementById('reports-view'),
            layoutSwitcher: document.getElementById('layout-switcher'),
            pageTitle: document.getElementById('page-title'),
            valueToggleBtn: document.getElementById('value-toggle-btn'),
            totalValue: document.getElementById('total-value'),
            mobileBackdrop: document.getElementById('mobile-backdrop'),
            compareBtn: document.getElementById('compare-btn'),
            comparisonModal: document.getElementById('comparison-modal'),
            closeComparisonModalBtn: document.getElementById('closeComparisonModalBtn'),
            comparisonContent: document.getElementById('comparison-content'),
        };

        const specDefinitions = { 'Planetary Gear': ['spec_innerDiameter', 'spec_outerDiameter', 'spec_length', 'spec_numberOfTeeth'], 'Sun Gear': ['spec_innerDiameter', 'spec_outerDiameter', 'spec_length', 'spec_numberOfTeethInOd', 'spec_numberOfTeethInId', 'spec_stepOd'], 'Ring Gear': ['spec_teeth', 'spec_outerDiameter', 'spec_innerDiameter'], 'Spline/Pinion Shaft': ['spec_bigTeethOd', 'spec_bigTeeth', 'spec_bigTeethLength', 'spec_smallTeethOd', 'spec_smallTeeth', 'spec_smallTeethLength', 'spec_length', 'spec_splineOd'], 'Track Motor Shaft': ['spec_length', 'spec_outerDiameter', 'spec_teethOd', 'spec_outsideTeeth', 'spec_insideTeeth', 'spec_insideOd'], 'Bearing': ['spec_innerDiameter', 'spec_outerDiameter', 'spec_width'], 'Bushes': ['spec_innerDiameter', 'spec_outerDiameter', 'spec_length'], };
        
        // ================================================================================
        // 2. AUTHENTICATION & API HANDLING
        // ================================================================================
        async function initializeGapiClient() {
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
            gapiInited = true; maybeEnableButtons();
        }
        function initializeGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: handleAuthResponse });
            gisInited = true; maybeEnableButtons();
        }
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                dom.authSignedOutView.onclick = handleAuthClick;
                dom.signInButtonMain.onclick = handleAuthClick;
                dom.signOutBtn.onclick = handleAuthClick;
                lucide.createIcons();
            }
        }
        function handleAuthResponse(resp) {
            if (resp.error !== undefined) {
                Swal.fire({ title: 'Authentication Error', text: 'Could not sign in. Please try again.', icon: 'error' });
                updateAuthStatus(false); return;
            }
            gapi.client.setToken(resp);
            updateAuthStatus(true);
        }
        function handleAuthClick() {
            if (!gapiInited || !gisInited) {
                Swal.fire('Loading...', 'Authentication libraries are still loading. Please try again in a moment.', 'info');
                return;
            }
            if (gapi.client.getToken() === null) {
                tokenClient?.requestAccessToken({ prompt: 'consent' });
            } else {
                Swal.fire({ title: 'Sign Out', text: 'Are you sure you want to sign out?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Yes, sign out'})
                .then((result) => { if (result.isConfirmed) { gapi.client.setToken(null); updateAuthStatus(false); } });
            }
        }
        async function updateAuthStatus(isSignedIn) {
            if (isSignedIn) {
                dom.loginView.classList.add('hidden');
                dom.appWrapper.classList.remove('hidden');
                dom.addPartBtn.disabled = false;
                dom.authSignedInView.classList.remove('hidden');
                dom.authSignedOutView.classList.add('hidden');
                
                try {
                    const userInfo = await gapi.client.oauth2.userinfo.get();
                    dom.userName.textContent = userInfo.result.name;
                    dom.userDp.src = userInfo.result.picture;
                } catch (e) {
                    dom.userName.textContent = "User";
                    dom.userDp.src = `https://ui-avatars.com/api/?name=U&background=E9ECEF&color=212529`;
                }
                loadAllData();
            } else {
                dom.loginView.classList.remove('hidden');
                dom.appWrapper.classList.add('hidden');
                dom.addPartBtn.disabled = true;
                dom.authSignedInView.classList.add('hidden');
                dom.authSignedOutView.classList.remove('hidden');
                allItems = [];
                allSales = [];
                sheetHeaders = [];
                localStorage.removeItem('inventoryData');
                processAndRenderItems();
            }
        }
        
        async function loadAllData() {
            const cachedData = JSON.parse(localStorage.getItem('inventoryData'));
            if (cachedData && (Date.now() - cachedData.timestamp < 3600000)) { // 1 hour cache
                allItems = cachedData.items;
                allSales = cachedData.sales;
                sheetHeaders = cachedData.headers;
                populateFilters();
                processAndRenderItems();
                renderReportCharts();
                return; // <-- Important: exit if using cache
            } 
            
            showSkeletonLoader(true);

            try {
                const responses = await Promise.all([
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: INVENTORY_RANGE }),
                    gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SPREADSHEET_ID, range: SALES_RANGE })
                ]);
                
                const inventoryValues = responses[0].result.values;
                // --- Check for empty sheet and capture headers ---
                if (!inventoryValues || inventoryValues.length === 0) {
                    Swal.fire('Sheet Error', 'The inventory sheet is empty or could not be read.', 'error');
                    showSkeletonLoader(false);
                    dom.noResults.classList.remove('hidden');
                    return;
                }
                sheetHeaders = inventoryValues[0]; // The actual headers from the sheet
                
                const freshItems = inventoryValues.slice(1).map((row, index) => {
                    const item = sheetHeaders.reduce((obj, header, i) => {
                        obj[header] = row[i];
                        return obj;
                    }, {});
                    item.rowIndex = index + 2;
                    return item;
                }).filter(item => item.id && item.id.trim() !== '');

                const salesValues = responses[1].result.values;
                const freshSales = (salesValues && salesValues.length > 1) ? salesValues.slice(1).map(row => ({
                    itemId: row[0],
                    quantitySold: parseInt(row[1], 10),
                    salePrice: parseFloat(row[2]),
                    date: row[3]
                })) : [];

                allItems = freshItems;
                allSales = freshSales;
                localStorage.setItem('inventoryData', JSON.stringify({
                    items: allItems,
                    sales: allSales,
                    headers: sheetHeaders, // Store headers in cache
                    timestamp: Date.now()
                }));

            } catch (err) {
                Swal.fire({ title: 'Data Loading Error', text: `Could not load data. Check Sheet ID and permissions. Error: ${err.result?.error?.message || 'Unknown error'}`, icon: 'error' });
                updateAuthStatus(false);
            } finally {
                showSkeletonLoader(false);
                populateFilters();
                processAndRenderItems();
                renderReportCharts();
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (isDuplicate()) {
                Swal.fire({
                    title: 'Duplicate Component',
                    text: 'An item with the same model, device, size, and name already exists. Please modify the details.',
                    icon: 'warning'
                });
                return;
            }

            const submitButton = e.currentTarget.querySelector('button[type="submit"]');
            const originalButtonHTML = submitButton.innerHTML;
            submitButton.innerHTML = `<svg class="animate-spin h-5 w-5 text-black" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Saving...`;
            submitButton.disabled = true;

            const editId = dom.editId.value;
            const action = editId ? updateComponent : addComponent;
            
            try {
                await action(editId);
            } finally {
                submitButton.innerHTML = originalButtonHTML;
                submitButton.disabled = false;
            }
        }

        async function addComponent() {
            const newItem = collectFormData();
            newItem.id = Date.now();
            // Use dynamic headers to build the row array
            const newRow = sheetHeaders.map(header => newItem[header] || "");
            try {
                await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: SPREADSHEET_ID, range: 'Sheet1!A1', valueInputOption: 'USER_ENTERED', resource: { values: [newRow] } });
                Swal.fire({ title: 'Success!', text: 'Component added successfully.', icon: 'success', timer: 2000, showConfirmButton: false });
                closeFormModal();
                localStorage.removeItem('inventoryData');
                loadAllData();
            } catch (err) {
                Swal.fire({ title: 'Save Error', text: `Could not save the component. Error: ${err.result?.error?.message || 'Unknown error'}`, icon: 'error' });
            }
        }

        async function updateComponent(id) {
            const itemToUpdate = allItems.find(item => item.id === id);
            if (!itemToUpdate) {
                Swal.fire('Error', 'Could not find the component to update.', 'error'); return;
            }
            const updatedItem = collectFormData();
            updatedItem.id = id;
            // Use dynamic headers to build the row array
            const updatedRow = sheetHeaders.map(header => updatedItem[header] || "");

            // ✅ FIX: Dynamically calculate the update range
            const endColumn = columnToLetter(sheetHeaders.length);
            const updateRange = `Sheet1!A${itemToUpdate.rowIndex}:${endColumn}${itemToUpdate.rowIndex}`;
            
            try {
                await gapi.client.sheets.spreadsheets.values.update({ spreadsheetId: SPREADSHEET_ID, range: updateRange, valueInputOption: 'USER_ENTERED', resource: { values: [updatedRow] }});
                Swal.fire({ title: 'Success!', text: 'Component updated successfully.', icon: 'success', timer: 2000, showConfirmButton: false });
                closeFormModal();
                localStorage.removeItem('inventoryData');
                loadAllData();
            } catch (err) {
                Swal.fire('Update Error', `Could not update the component. Error: ${err.result?.error?.message || 'Unknown error'}`, 'error');
            }
        }

        async function deleteComponent(id) {
            const itemToDelete = allItems.find(item => item.id === id);
            if (!itemToDelete) {
                Swal.fire('Error', 'Could not find the component to delete.', 'error'); return;
            }
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({ spreadsheetId: SPREADSHEET_ID, resource: { requests: [{ deleteDimension: { range: { sheetId: 0, dimension: 'ROWS', startIndex: itemToDelete.rowIndex - 1, endIndex: itemToDelete.rowIndex }}}]}});
                Swal.fire('Deleted!', 'The component has been deleted.', 'success');
                closeDetailPanel();
                localStorage.removeItem('inventoryData');
                loadAllData();
            } catch (err) {
                 Swal.fire('Delete Error', `Could not delete the component. Error: ${err.result?.error?.message || 'Unknown error'}`, 'error');
            }
        }

        // ================================================================================
        // 3. UI RENDERING & LOGIC
        // ================================================================================
        function processAndRenderItems() {
            if (!gapiInited) return;
            const searchTerm = dom.search.value.toLowerCase();
            const deviceFilter = dom.filterDevice.value;
            const sizeFilter = dom.filterSize.value;
            const sortBy = dom.sortBy.value;

            filteredItems = allItems.filter(item => {
                const searchMatch = Object.values(item).join(' ').toLowerCase().includes(searchTerm);
                const deviceMatch = !deviceFilter || item.device === deviceFilter;
                const sizeMatch = !sizeFilter || item.size === sizeFilter;
                return searchMatch && deviceMatch && sizeMatch;
            });

            switch (sortBy) {
                case 'price-desc': filteredItems.sort((a, b) => (parseFloat(b.price) || 0) - (parseFloat(a.price) || 0)); break;
                case 'quantity-asc': filteredItems.sort((a, b) => (parseInt(a.quantity) || 0) - (parseInt(b.quantity) || 0)); break;
                default: filteredItems.sort((a, b) => (a.model || '').localeCompare(b.model || '')); break;
            }
            
            updateAnalytics(allItems);
            renderItems();
        }

        function renderItems() {
            if (!gapiInited || !gapi.client || (typeof gapi.client.getToken !== 'function')) return;
            dom.searchResults.innerHTML = '';
            dom.noResults.classList.toggle('hidden', filteredItems.length > 0 || !gapi.client.getToken());
            dom.searchResults.classList.toggle('hidden', filteredItems.length === 0 && currentLayout !== 'kanban');
            
            const paginatedItems = filteredItems.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);
            
            if (paginatedItems.length === 0 && currentPage > 1) {
                currentPage = 1; renderItems(); return;
            }

            const fragment = document.createDocumentFragment();
            switch(currentLayout) {
                case 'grid':
                    dom.searchResults.className = 'grid gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5';
                    paginatedItems.forEach(item => fragment.appendChild(createGridCard(item)));
                    break;
                case 'list':
                    dom.searchResults.className = 'space-y-3';
                    paginatedItems.forEach(item => fragment.appendChild(createListCard(item)));
                    break;
                case 'table':
                    dom.searchResults.className = 'w-full overflow-x-auto';
                    fragment.appendChild(createTableView(paginatedItems));
                    break;
                case 'kanban':
                    dom.searchResults.className = 'grid lg:grid-cols-3 gap-6 items-start';
                    fragment.appendChild(createKanbanView(filteredItems));
                    break;
            }
            
            dom.searchResults.appendChild(fragment);
            updatePaginationVisibility();
            lucide.createIcons();
            initGalleries();
            renderPaginationControls();
        }

        function createGridCard(item) {
            const card = document.createElement('div');
            card.className = 'industrial-card overflow-hidden flex flex-col group';
            const images = (item.imageLinks || '').split(',').map(link => link.trim()).filter(Boolean);
            const firstImage = getDriveThumbnail(images[0]) || `https://ui-avatars.com/api/?name=${encodeURIComponent(item.itemName || 'N/A')}&background=E9ECEF&color=212529&size=512&bold=true`;
            const quantity = parseInt(item.quantity) || 0;
            const statusColor = quantity === 0 ? 'bg-[var(--color-status-danger)]' : quantity < 5 ? 'bg-[var(--color-status-warning)]' : 'bg-[var(--color-status-success)]';
            const statusText = quantity > 0 ? `${quantity} in Stock` : 'Out of Stock';
            const isChecked = comparisonList.has(item.id);

            card.innerHTML = `
                <div class="relative image-gallery bg-[var(--color-bg-tertiary)]" data-images="${images.join(',')}">
                    <img loading="lazy" src="${firstImage}" alt="${item.itemName}" class="gallery-image w-full h-52 object-contain" onerror="this.src='https://ui-avatars.com/api/?name=Error&background=F8D7DA&color=721C24&size=512&bold=true';">
                    ${images.length > 1 ? `<button aria-label="Previous image" class="gallery-arrow absolute left-2 top-1/2 -translate-y-1/2 p-1 bg-black/50 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity" data-direction="-1"><i data-lucide="chevron-left"></i></button><button aria-label="Next image" class="gallery-arrow absolute right-2 top-1/2 -translate-y-1/2 p-1 bg-black/50 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity" data-direction="1"><i data-lucide="chevron-right"></i></button>` : ''}
                    <div class="absolute top-2 left-2 flex items-center gap-2 text-xs font-bold px-2 py-1 rounded text-white ${statusColor}">${statusText}</div>
                    <input type="checkbox" data-id="${item.id}" class="compare-checkbox absolute top-2 right-2 h-5 w-5" ${isChecked ? 'checked' : ''}>
                </div>
                <div class="p-4 flex-grow flex flex-col">
                    <h3 class="font-bold leading-tight capitalize">${[item.model, item.device, item.size, item.itemName].filter(Boolean).join(' ').toLowerCase()}</h3>
                    <p class="text-sm text-[var(--color-text-secondary)] mt-1">Price: <span class="font-semibold text-[var(--color-text-primary)]">₹${item.price || 'N/A'}</span></p>
                    <div class="mt-auto pt-4 text-right">
                        <button class="view-details-btn text-sm font-bold text-[var(--color-accent-main)] hover:underline" data-id="${item.id}">View Details &rarr;</button>
                    </div>
                </div>`;
            return card;
        }

        function createListCard(item) {
            const card = document.createElement('div');
            card.className = 'industrial-card p-4 flex items-center gap-4';
            const image = getDriveThumbnail((item.imageLinks || '').split(',')[0]) || `https://ui-avatars.com/api/?name=${encodeURIComponent(item.itemName || 'N/A')}&background=E9ECEF&color=212529&size=128&bold=true`;
            const quantity = parseInt(item.quantity) || 0;
            const statusColor = quantity === 0 ? 'text-[var(--color-status-danger)]' : quantity < 5 ? 'text-[var(--color-status-warning)]' : 'text-[var(--color-status-success)]';
            const isChecked = comparisonList.has(item.id);

            card.innerHTML = `
                <input type="checkbox" data-id="${item.id}" class="compare-checkbox h-5 w-5 flex-shrink-0" ${isChecked ? 'checked' : ''}>
                <img loading="lazy" src="${image}" class="w-16 h-16 rounded-md object-contain flex-shrink-0 bg-[var(--color-bg-tertiary)]" onerror="this.src='https://ui-avatars.com/api/?name=Error&background=F8D7DA&color=721C24&size=128&bold=true';">
                <div class="flex-1 grid grid-cols-1 md:grid-cols-5 gap-4 items-center">
                    <h3 class="md:col-span-2 font-semibold capitalize">${[item.model, item.device, item.size, item.itemName].filter(Boolean).join(' ').toLowerCase()}</h3>
                    <p class="text-[var(--color-text-secondary)]">₹${item.price || 'N/A'}</p>
                    <p class="${statusColor} font-medium">${quantity > 0 ? `${quantity} in Stock` : 'Out of Stock'}</p>
                    <div class="md:text-right"><button class="view-details-btn text-sm font-bold text-[var(--color-accent-main)] hover:underline" data-id="${item.id}">Details</button></div>
                </div>`;
            return card;
        }

        function createTableView(items) {
            const table = document.createElement('table');
            table.className = 'w-full text-left border-collapse industrial-card';
            let head = `<thead><tr class="border-b border-[var(--color-border-primary)]">
                <th class="p-4"></th>
                <th class="p-4 font-semibold">Component</th>
                <th class="p-4 font-semibold">Price</th>
                <th class="p-4 font-semibold">Quantity</th>
                <th class="p-4 font-semibold">Actions</th>
            </tr></thead>`;
            
            let body = '<tbody>';
            items.forEach(item => {
                const quantity = parseInt(item.quantity) || 0;
                const statusColor = quantity === 0 ? 'text-[var(--color-status-danger)]' : quantity < 5 ? 'text-[var(--color-status-warning)]' : 'text-[var(--color-status-success)]';
                const isChecked = comparisonList.has(item.id);
                body += `<tr class="border-b border-[var(--color-border-primary)] last:border-b-0 hover:bg-[var(--color-bg-tertiary)]">
                    <td class="p-4"><input type="checkbox" data-id="${item.id}" class="compare-checkbox h-5 w-5" ${isChecked ? 'checked' : ''}></td>
                    <td class="p-4 capitalize font-medium">${[item.model, item.device, item.size, item.itemName].filter(Boolean).join(' ').toLowerCase()}</td>
                    <td class="p-4 text-[var(--color-text-secondary)]">₹${item.price || 'N/A'}</td>
                    <td class="p-4 font-medium ${statusColor}">${quantity}</td>
                    <td class="p-4"><button class="view-details-btn text-sm font-bold text-[var(--color-accent-main)] hover:underline" data-id="${item.id}">Details</button></td>
                </tr>`;
            });
            body += '</tbody>';
            table.innerHTML = head + body;
            return table;
        }

        function createKanbanView(items) {
            const container = document.createElement('div');
            const columns = {
                inStock: { title: 'In Stock', items: [], color: 'var(--color-status-success)' },
                lowStock: { title: 'Low Stock', items: [], color: 'var(--color-status-warning)' },
                outOfStock: { title: 'Out of Stock', items: [], color: 'var(--color-status-danger)' },
            };

            items.forEach(item => {
                const quantity = parseInt(item.quantity) || 0;
                if (quantity === 0) columns.outOfStock.items.push(item);
                else if (quantity < 5) columns.lowStock.items.push(item);
                else columns.inStock.items.push(item);
            });

            for (const key in columns) {
                const col = columns[key];
                const colDiv = document.createElement('div');
                colDiv.className = 'flex flex-col gap-4';
                let cardsHtml = col.items.map(item => {
                    const isChecked = comparisonList.has(item.id);
                    return `<div class="industrial-card p-4">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold capitalize pr-2">${[item.model, item.itemName].filter(Boolean).join(' ').toLowerCase()}</h4>
                            <input type="checkbox" data-id="${item.id}" class="compare-checkbox h-5 w-5 flex-shrink-0" ${isChecked ? 'checked' : ''}>
                        </div>
                        <p class="text-sm text-[var(--color-text-secondary)]">${item.device || ''} ${item.size || ''}</p>
                        <div class="mt-4 pt-4 border-t border-[var(--color-border-primary)] flex justify-between items-center">
                            <span class="font-semibold">Qty: ${item.quantity}</span>
                            <button class="view-details-btn text-sm font-bold text-[var(--color-accent-main)] hover:underline" data-id="${item.id}">Details</button>
                        </div>
                    </div>`;
                }).join('');

                colDiv.innerHTML = `
                    <div class="flex items-center gap-3 pb-2 border-b-4" style="border-color: ${col.color};">
                        <h3 class="text-lg font-black">${col.title}</h3>
                        <span class="font-bold text-sm bg-[var(--color-bg-tertiary)] px-2.5 py-0.5 rounded-full">${col.items.length}</span>
                    </div>
                    <div class="flex flex-col gap-4">${cardsHtml || '<p class="text-sm text-center text-[var(--color-text-secondary)] p-4">No items in this category.</p>'}</div>
                `;
                container.appendChild(colDiv);
            }
            return container;
        }

        function switchLayout(layout) {
            currentLayout = layout;
            localStorage.setItem('layout', layout);
            
            ['gridViewBtn', 'listViewBtn', 'tableViewBtn', 'kanbanViewBtn'].forEach(btnId => {
                dom[btnId].classList.remove('bg-[var(--color-bg-secondary)]', 'text-[var(--color-accent-main)]');
            });
            dom[layout + 'ViewBtn'].classList.add('bg-[var(--color-bg-secondary)]', 'text-[var(--color-accent-main)]');
            
            processAndRenderItems();
        }

        function showSkeletonLoader(show) {
            dom.skeletonLoader.classList.toggle('hidden', !show);
            dom.searchResults.classList.add('hidden');
            dom.noResults.classList.add('hidden');
            if (show) {
                let skeletonHtml = '';
                for(let i = 0; i < 12; i++) { 
                    skeletonHtml += `<div class="industrial-card p-4 space-y-4"><div class="skeleton-item h-48 rounded"></div><div class="space-y-2"><div class="skeleton-item h-6 w-3/4 rounded"></div><div class="skeleton-item h-4 w-1/2 rounded"></div></div></div>`; 
                }
                dom.skeletonLoader.innerHTML = `<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 skeleton-breathe">${skeletonHtml}</div>`;
            }
        }

        function initThemeAndLayout() {
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                dom.html.classList.add('dark');
            } else {
                dom.html.classList.remove('dark');
            }
            switchLayout(localStorage.getItem('layout') || 'grid');
            updateValueVisibility();
        }

        function toggleTheme() {
            dom.html.classList.toggle('dark');
            localStorage.setItem('theme', dom.html.classList.contains('dark') ? 'dark' : 'light');
            if(revenueChart) renderReportCharts();
        }

        function getDriveThumbnail(url) {
            if (!url) return null;
            const match = url.match(/file\/d\/([a-zA-Z0-9_-]+)/);
            return match ? `https://drive.google.com/thumbnail?id=${match[1]}&sz=w512-h512` : url;
        }

        function initGalleries() {
            document.querySelectorAll('.image-gallery').forEach(gallery => {
                const images = (gallery.dataset.images || '').split(',').map(link => link.trim()).filter(Boolean);
                if (images.length <= 1) return;
                let currentIndex = 0;
                const imgElement = gallery.querySelector('.gallery-image');
                gallery.querySelectorAll('.gallery-arrow').forEach(arrow => {
                    arrow.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const direction = parseInt(e.currentTarget.dataset.direction);
                        currentIndex = (currentIndex + direction + images.length) % images.length;
                        imgElement.src = getDriveThumbnail(images[currentIndex]);
                    });
                });
            });
        }
        
        // ================================================================================
        // 4. MODALS & FORMS
        // ================================================================================
        function openAddModal() {
            dom.formTitle.textContent = 'Add New Component';
            dom.editId.value = '';
            dom.partForm.reset();
            dom.specFieldsContainer.classList.add('hidden');
            dom.specFields.innerHTML = '';
            dom.formModal.classList.remove('hidden');
            dom.formModal.classList.add('flex');
            trapFocus(dom.formModal);
        }

        function openEditModal(item) {
            dom.formTitle.textContent = 'Edit Component';
            dom.editId.value = item.id;
            dom.partForm.querySelector('#model').value = item.model || '';
            dom.partForm.querySelector('#device').value = item.device || '';
            dom.partForm.querySelector('#size').value = item.size || '';
            dom.itemNameSelect.value = item.itemName || '';
            dom.partForm.querySelector('#price').value = item.price || '';
            dom.partForm.querySelector('#quantity').value = item.quantity || '0';
            dom.imageLinksInput.value = item.imageLinks || '';
            dom.partForm.querySelector('#note').value = item.note || '';
            updateSpecFields();
            Object.keys(item).forEach(key => {
                if (key.startsWith('spec_')) {
                    const input = dom.partForm.querySelector(`[name="${key}"]`);
                    if (input) input.value = item[key];
                }
            });
            dom.formModal.classList.remove('hidden');
            dom.formModal.classList.add('flex');
            trapFocus(dom.formModal);
        }

        function closeFormModal() { 
            dom.formModal.classList.add('hidden'); dom.formModal.classList.remove('flex');
            dom.partForm.reset();
            dom.specFieldsContainer.classList.add('hidden');
            dom.specFields.innerHTML = '';
        }

        function collectFormData() {
            const formData = {
                model: dom.partForm.querySelector('#model').value,
                device: dom.partForm.querySelector('#device').value,
                size: dom.partForm.querySelector('#size').value,
                itemName: dom.itemNameSelect.value,
                price: dom.partForm.querySelector('#price').value,
                quantity: dom.partForm.querySelector('#quantity').value,
                imageLinks: dom.imageLinksInput.value,
                note: dom.partForm.querySelector('#note').value,
            };
            dom.partForm.querySelectorAll('#spec-fields input').forEach(input => { formData[input.name] = input.value; });
            return formData;
        }

        function updateSpecFields() {
            const selectedType = dom.itemNameSelect.value;
            dom.specFields.innerHTML = '';
            if (selectedType && specDefinitions[selectedType]) {
                dom.specFieldsContainer.classList.remove('hidden');
                specDefinitions[selectedType].forEach(specName => { dom.specFields.appendChild(createSpecInput(specName)); });
            } else {
                dom.specFieldsContainer.classList.add('hidden');
            }
        }

        function createSpecInput(specName) {
            const id = specName.replace(/_/g, '-');
            const wrapper = document.createElement('div');
            const labelText = specName.replace('spec_', '').replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            wrapper.innerHTML = `<label for="${id}">${labelText}</label><input type="text" id="${id}" name="${specName}" class="mt-1 industrial-input">`;
            return wrapper;
        }

        function openDetailPanel(item) {
            populateDetailPanel(item);
            dom.detailModal.classList.remove('hidden');
            requestAnimationFrame(() => {
                dom.detailModal.classList.remove('opacity-0', 'scale-95');
                trapFocus(dom.detailModal);
            });
        }

        function closeDetailPanel() {
            dom.detailModal.classList.add('opacity-0', 'scale-95');
            setTimeout(() => { dom.detailModal.classList.add('hidden'); }, 300);
        }

        function populateDetailPanel(item) {
            const images = (item.imageLinks || '').split(',').map(link => link.trim()).filter(Boolean);
            
            let teethSpecsHtml = '';
            let otherSpecsHtml = '';
            const teethKeys = ['spec_teeth', 'spec_numberOfTeeth', 'spec_numberOfTeethInOd', 'spec_numberOfTeethInId', 'spec_bigTeethOd', 'spec_bigTeeth', 'spec_bigTeethLength', 'spec_smallTeethOd', 'spec_smallTeeth', 'spec_smallTeethLength', 'spec_teethOd', 'spec_outsideTeeth', 'spec_insideTeeth'];

            Object.keys(item).forEach(key => {
                if (key.startsWith('spec_') && item[key]) {
                    const label = key.replace('spec_', '').replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    const specRow = `<div class="flex justify-between py-2"><dt class="text-[var(--color-text-secondary)]">${label}</dt><dd class="font-semibold text-right">${item[key]}</dd></div>`;
                    if (teethKeys.includes(key)) {
                        teethSpecsHtml += specRow;
                    } else {
                        otherSpecsHtml += specRow;
                    }
                }
            });

            dom.detailContent.innerHTML = `
                <div class="lg:col-span-2 p-6 flex items-center justify-center bg-[var(--color-bg-primary)] image-gallery" data-images="${images.join(',')}" data-current-index="0">
                    ${images.length > 0 ? `
                        <div class="relative w-full h-full">
                           <img loading="lazy" src="${getDriveThumbnail(images[0])}" class="gallery-image w-full max-h-[75vh] h-full object-contain rounded-lg" onerror="this.src='https://ui-avatars.com/api/?name=No+Image&background=E9ECEF&color=212529&size=512&bold=true';">
                           ${images.length > 1 ? `<button aria-label="Previous image" class="detail-gallery-arrow absolute left-3 top-1/2 -translate-y-1/2 p-2 bg-black/50 rounded-full text-white hover:bg-black/75 transition-colors" data-direction="-1"><i data-lucide="chevron-left" class="pointer-events-none"></i></button><button aria-label="Next image" class="detail-gallery-arrow absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-black/50 rounded-full text-white hover:bg-black/75 transition-colors" data-direction="1"><i data-lucide="chevron-right" class="pointer-events-none"></i></button>` : ''}
                        </div>
                    ` : `<div class="h-full flex items-center justify-center text-[var(--color-text-secondary)]">No Images</div>`}
                </div>
                <div class="lg:col-span-1 p-6 space-y-6 border-l border-[var(--color-border-primary)]">
                    <div>
                        <p class="text-sm font-bold text-[var(--color-accent-main)] uppercase">${item.itemName || 'Component'}</p>
                        <h3 class="text-3xl font-black capitalize">${[item.model, item.device, item.size].filter(Boolean).join(' ').toLowerCase()}</h3>
                    </div>
                    
                    <div class="bg-[var(--color-bg-tertiary)] p-4 rounded-lg border border-[var(--color-border-primary)]">
                        <h4 class="text-lg font-bold mb-3">Stock & Ordering</h4>
                        <dl class="space-y-2">
                           <div class="flex justify-between items-baseline"><dt class="text-[var(--color-text-secondary)]">Price</dt><dd class="text-2xl font-bold">₹${item.price || 'N/A'}</dd></div>
                           <div class="flex justify-between items-baseline"><dt class="text-[var(--color-text-secondary)]">Quantity</dt><dd class="text-2xl font-bold">${item.quantity || '0'}</dd></div>
                        </dl>
                        <div class="flex items-center gap-3 mt-4">
                           <button data-id="${item.id}" class="edit-btn btn btn--secondary flex-1"><i data-lucide="edit"></i>Edit</button>
                           <button data-id="${item.id}" class="delete-btn btn btn--danger flex-1"><i data-lucide="trash-2"></i>Delete</button>
                        </div>
                    </div>

                    ${teethSpecsHtml ? `<div><h4 class="text-lg font-bold mb-2">Teeth Details</h4><dl class="text-sm divide-y divide-[var(--color-border-primary)] border-y border-[var(--color-border-primary)]">${teethSpecsHtml}</dl></div>` : ''}
                    ${otherSpecsHtml ? `<div><h4 class="text-lg font-bold mb-2">General Specifications</h4><dl class="text-sm divide-y divide-[var(--color-border-primary)] border-y border-[var(--color-border-primary)]">${otherSpecsHtml}</dl></div>` : ''}

                    ${item.note ? `<div><h4 class="text-lg font-bold mb-2">Notes</h4><p class="text-sm p-3 bg-[var(--color-bg-tertiary)] rounded border border-[var(--color-border-primary)]">${item.note}</p></div>` : ''}
                </div>`;
            lucide.createIcons();
        }
        
        // ================================================================================
        // 5. ANALYTICS & HELPERS
        // ================================================================================
        
        // ✅ FIX: Helper function to convert column number to Letter (e.g., 1 -> A, 27 -> AA)
        function columnToLetter(column) {
            let temp, letter = '';
            while (column > 0) {
                temp = (column - 1) % 26;
                letter = String.fromCharCode(temp + 65) + letter;
                column = (column - temp - 1) / 26;
            }
            return letter;
        }

        function isDuplicate() {
            const form = dom.partForm;
            const model = form.querySelector('#model').value.trim().toLowerCase();
            const device = form.querySelector('#device').value.trim().toLowerCase();
            const size = form.querySelector('#size').value.trim().toLowerCase();
            const itemName = form.querySelector('#item-name-main').value.trim().toLowerCase();
            const editId = form.querySelector('#edit-id').value;

            return allItems.some(item => {
                if (item.id === editId) return false;

                return (item.model || '').trim().toLowerCase() === model &&
                       (item.device || '').trim().toLowerCase() === device &&
                       (item.size || '').trim().toLowerCase() === size &&
                       (item.itemName || '').trim().toLowerCase() === itemName;
            });
        }

        function populateFilters() {
            const devices = [...new Set(allItems.map(item => item.device).filter(Boolean))];
            const sizes = [...new Set(allItems.map(item => item.size).filter(Boolean))];
            dom.filterDevice.innerHTML = '<option value="">All Devices</option>';
            devices.forEach(d => dom.filterDevice.innerHTML += `<option value="${d}">${d}</option>`);
            dom.filterSize.innerHTML = '<option value="">All Sizes</option>';
            sizes.forEach(s => dom.filterSize.innerHTML += `<option value="${s}">${s}</option>`);
        }

        function updateAnalytics(items) {
            document.getElementById('total-components').textContent = items.length;
            
            const totalValue = items.reduce((sum, item) => sum + (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 0), 0);
            localStorage.setItem('inventoryTotalValue', totalValue);
            updateValueVisibility();

            const lowStockCount = items.filter(item => (parseInt(item.quantity) || 0) < 5 && (parseInt(item.quantity) || 0) > 0).length;
            const lowStockEl = document.getElementById('low-stock');
            lowStockEl.textContent = lowStockCount;
            lowStockEl.style.color = lowStockCount > 0 ? 'var(--color-status-warning)' : 'var(--color-status-success)';
            
            const outOfStockCount = items.filter(item => (parseInt(item.quantity) || 0) === 0).length;
            document.getElementById('out-of-stock').textContent = outOfStockCount;
        }

        function toggleValueVisibility() {
            isValueVisible = !isValueVisible;
            updateValueVisibility();
        }

        function updateValueVisibility() {
            const totalValue = parseFloat(localStorage.getItem('inventoryTotalValue') || '0');
            dom.totalValue.textContent = `₹${totalValue.toLocaleString('en-IN')}`;
            if (isValueVisible) {
                dom.totalValue.classList.remove('blurred-value');
                dom.valueToggleBtn.innerHTML = `<i data-lucide="eye" class="w-5 h-5"></i>`;
            } else {
                dom.totalValue.classList.add('blurred-value');
                dom.valueToggleBtn.innerHTML = `<i data-lucide="eye-off" class="w-5 h-5"></i>`;
            }
            lucide.createIcons();
        }
        
        function updatePaginationVisibility() {
            dom.paginationControls.style.display = currentLayout === 'kanban' ? 'none' : 'flex';
        }

        function renderPaginationControls() {
            const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
            dom.paginationControls.innerHTML = '';
            if (totalPages <= 1) return;
            let html = `<button data-page="${currentPage - 1}" class="btn btn--secondary" ${currentPage === 1 ? 'disabled' : ''}>&larr; Prev</button>`;
            html += `<span class="font-semibold text-[var(--color-text-secondary)]">Page ${currentPage} of ${totalPages}</span>`;
            html += `<button data-page="${currentPage + 1}" class="btn btn--secondary" ${currentPage === totalPages ? 'disabled' : ''}>Next &rarr;</button>`;
            dom.paginationControls.innerHTML = html;
        }

        function switchView(view) {
            document.querySelectorAll('.sidebar-nav-link').forEach(l => l.classList.remove('active'));
            if (view === 'dashboard') {
                dom.navDashboard.classList.add('active');
                dom.dashboardView.classList.remove('hidden');
                dom.reportsView.classList.add('hidden');
                dom.layoutSwitcher.classList.remove('hidden');
                dom.pageTitle.textContent = "Dashboard";
            } else if (view === 'reports') {
                dom.navReports.classList.add('active');
                dom.dashboardView.classList.add('hidden');
                dom.reportsView.classList.remove('hidden');
                dom.layoutSwitcher.classList.add('hidden');
                dom.pageTitle.textContent = "Reports";
            }
        }

        function toggleMobileSidebar() {
            const isOpen = dom.sidebar.classList.toggle('open');
            dom.mobileBackdrop.classList.toggle('hidden', !isOpen);
        }

        function trapFocus(element) {
            const focusableEls = element.querySelectorAll('a[href]:not([disabled]), button:not([disabled]), textarea:not([disabled]), input[type="text"]:not([disabled]), input[type="radio"]:not([disabled]), input[type="checkbox"]:not([disabled]), select:not([disabled])');
            const firstFocusableEl = focusableEls[0];
            const lastFocusableEl = focusableEls[focusableEls.length - 1];
            const KEYCODE_TAB = 9;

            element.addEventListener('keydown', function(e) {
                if (e.key !== 'Tab' && e.keyCode !== KEYCODE_TAB) return;
                if (e.shiftKey) {
                    if (document.activeElement === firstFocusableEl) {
                        lastFocusableEl.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === lastFocusableEl) {
                        firstFocusableEl.focus();
                        e.preventDefault();
                    }
                }
            });
            if(firstFocusableEl) firstFocusableEl.focus();
        }

        // ================================================================================
        // 6. CHARTING
        // ================================================================================
        function renderReportCharts() {
            const isDark = dom.html.classList.contains('dark');
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--color-text-secondary');
            const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--color-border-primary');

            const monthlyRevenue = allSales.reduce((acc, sale) => {
                const month = new Date(sale.date).toLocaleString('default', { month: 'short', year: 'numeric' });
                const revenue = sale.quantitySold * sale.salePrice;
                acc[month] = (acc[month] || 0) + revenue;
                return acc;
            }, {});

            const bestSellers = allSales.reduce((acc, sale) => {
                const item = allItems.find(i => i.id === sale.itemId);
                if (item) {
                    const itemName = [item.model, item.itemName].filter(Boolean).join(' ');
                    acc[itemName] = (acc[itemName] || 0) + sale.quantitySold;
                }
                return acc;
            }, {});
            
            const sortedBestSellers = Object.entries(bestSellers).sort((a, b) => b[1] - a[1]).slice(0, 5);

            const chartOptions = {
                plugins: { legend: { labels: { color: textColor } } },
                scales: {
                    x: { ticks: { color: textColor }, grid: { color: gridColor } },
                    y: { ticks: { color: textColor }, grid: { color: gridColor } }
                }
            };

            if (revenueChart) revenueChart.destroy();
            revenueChart = new Chart(document.getElementById('revenue-chart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(monthlyRevenue),
                    datasets: [{ label: 'Monthly Revenue', data: Object.values(monthlyRevenue), backgroundColor: 'rgba(255, 193, 7, 0.5)', borderColor: 'rgb(255, 193, 7)', borderWidth: 1 }]
                },
                options: chartOptions
            });

            if (bestsellersChart) bestsellersChart.destroy();
            bestsellersChart = new Chart(document.getElementById('bestsellers-chart'), {
                type: 'doughnut',
                data: {
                    labels: sortedBestSellers.map(item => item[0]),
                    datasets: [{ label: 'Quantity Sold', data: sortedBestSellers.map(item => item[1]), backgroundColor: ['#FFC107', '#FFCA28', '#FFD54F', '#FFE082', '#FFECB3'], borderColor: isDark ? '#1E1E1E' : '#FFFFFF' }]
                },
                options: { plugins: { legend: { position: 'right', labels: { color: textColor } } } }
            });
        }
        
        // ================================================================================
        // 7. COMPARISON LOGIC
        // ================================================================================
        function updateCompareButton() {
            const count = comparisonList.size;
            if (count >= 2) {
                dom.compareBtn.classList.remove('hidden');
                dom.compareBtn.textContent = `Compare (${count})`;
            } else {
                dom.compareBtn.classList.add('hidden');
            }
        }

        function openComparisonModal() {
            const itemsToCompare = allItems.filter(item => comparisonList.has(item.id));
            if (itemsToCompare.length < 2) return;

            const allKeys = new Set(['itemName', 'model', 'device', 'size', 'price', 'quantity']);
            itemsToCompare.forEach(item => {
                Object.keys(item).forEach(key => {
                    if (key.startsWith('spec_') && item[key]) {
                        allKeys.add(key);
                    }
                });
            });

            let tableHTML = '<table class="w-full text-left border-collapse"><thead><tr><th class="p-3 font-semibold border-b-2 border-[var(--color-border-primary)]">Feature</th>';
            itemsToCompare.forEach(item => {
                tableHTML += `<th class="p-3 font-semibold border-b-2 border-[var(--color-border-primary)] capitalize">${[item.model, item.itemName].filter(Boolean).join(' ').toLowerCase()}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            allKeys.forEach(key => {
                const label = key.replace('spec_', '').replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                tableHTML += `<tr class="border-b border-[var(--color-border-primary)] last:border-0"><td class="p-3 font-medium text-[var(--color-text-secondary)]">${label}</td>`;
                itemsToCompare.forEach(item => {
                    tableHTML += `<td class="p-3">${item[key] || 'N/A'}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            dom.comparisonContent.innerHTML = tableHTML;
            dom.comparisonModal.classList.remove('hidden');
            dom.comparisonModal.classList.add('flex');
        }

        function closeComparisonModal() {
            dom.comparisonModal.classList.add('hidden');
            dom.comparisonModal.classList.remove('flex');
        }

        // ================================================================================
        // 8. EVENT LISTENERS & INITIALIZATION
        // ================================================================================
        function handlePaginationClick(e) {
            const button = e.target.closest('button');
            if (button && !button.disabled) {
                currentPage = parseInt(button.dataset.page);
                renderItems();
                window.scrollTo(0, 0);
            }
        }

        function handleCardClick(e) {
            const viewBtn = e.target.closest('.view-details-btn');
            if (viewBtn) {
                const itemId = viewBtn.dataset.id;
                const item = allItems.find(i => i.id === itemId);
                if (item) openDetailPanel(item);
                return;
            }

            const checkbox = e.target.closest('.compare-checkbox');
            if (checkbox) {
                const itemId = checkbox.dataset.id;
                if (checkbox.checked) {
                    comparisonList.add(itemId);
                } else {
                    comparisonList.delete(itemId);
                }
                updateCompareButton();
            }
        }

        function handleDetailPanelClick(e) {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const arrowBtn = e.target.closest('.detail-gallery-arrow');

            if (editBtn) {
                const itemId = editBtn.dataset.id;
                const item = allItems.find(i => i.id === itemId);
                if (item) { closeDetailPanel(); openEditModal(item); }
            }
            if (deleteBtn) {
                const itemId = deleteBtn.dataset.id;
                Swal.fire({
                    title: 'Are you absolutely sure?',
                    text: "This action cannot be undone!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, delete it!',
                    confirmButtonColor: 'var(--color-status-danger)',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        deleteComponent(itemId);
                    }
                });
            }
            if (arrowBtn) {
                const gallery = arrowBtn.closest('.image-gallery');
                const images = (gallery.dataset.images || '').split(',').map(link => link.trim()).filter(Boolean);
                if (images.length <= 1) return;
                let currentIndex = parseInt(gallery.dataset.currentIndex || '0');
                const direction = parseInt(arrowBtn.dataset.direction);
                currentIndex = (currentIndex + direction + images.length) % images.length;
                gallery.querySelector('.gallery-image').src = getDriveThumbnail(images[currentIndex]);
                gallery.dataset.currentIndex = currentIndex;
            }
        }

        // --- Initialize App ---
        initThemeAndLayout();
        gapi.load('client', initializeGapiClient);
        const gisScript = document.createElement('script');
        gisScript.src = 'https://accounts.google.com/gsi/client';
        gisScript.async = true;
        gisScript.defer = true;
        gisScript.onload = initializeGis;
        document.body.appendChild(gisScript);

        dom.partForm.addEventListener('submit', handleFormSubmit);
        
        dom.search.addEventListener('input', () => {
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(() => {
                currentPage = 1;
                processAndRenderItems();
            }, 300);
        });

        [dom.filterDevice, dom.filterSize, dom.sortBy].forEach(el => el.addEventListener('change', () => {
            currentPage = 1;
            processAndRenderItems();
        }));

        dom.addPartBtn.addEventListener('click', openAddModal);
        dom.closeFormModalBtn.addEventListener('click', closeFormModal);
        dom.cancelBtn.addEventListener('click', closeFormModal);
        dom.menuBtn.addEventListener('click', toggleMobileSidebar);
        dom.mobileBackdrop.addEventListener('click', toggleMobileSidebar);
        dom.itemNameSelect.addEventListener('change', updateSpecFields);
        dom.gridViewBtn.addEventListener('click', () => switchLayout('grid'));
        dom.listViewBtn.addEventListener('click', () => switchLayout('list'));
        dom.tableViewBtn.addEventListener('click', () => switchLayout('table'));
        dom.kanbanViewBtn.addEventListener('click', () => switchLayout('kanban'));
        dom.themeToggle.addEventListener('click', toggleTheme);
        dom.detailCloseBtn.addEventListener('click', closeDetailPanel);
        dom.detailBackdrop.addEventListener('click', closeDetailPanel);
        dom.searchResults.addEventListener('click', handleCardClick);
        dom.detailContent.addEventListener('click', handleDetailPanelClick);
        dom.paginationControls.addEventListener('click', handlePaginationClick);
        [dom.navDashboard, dom.navReports].forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const view = e.currentTarget.id === 'nav-dashboard' ? 'dashboard' : 'reports';
                switchView(view);
                if (window.innerWidth < 1024) {
                    toggleMobileSidebar();
                }
            });
        });
        dom.valueToggleBtn.addEventListener('click', toggleValueVisibility);
        dom.compareBtn.addEventListener('click', openComparisonModal);
        dom.closeComparisonModalBtn.addEventListener('click', closeComparisonModal);
    });
    </script>
</body>
</html>
